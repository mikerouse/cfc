{% extends "base.html" %}

{% block title %}{{ page_title }} - Council Finance Counters{% endblock %}

{% block extra_head %}
<!-- Cache busting for development -->
<meta name="cache-version" content="{{ cache_version }}">
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-6">
    <!-- Header Section -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <nav class="flex" aria-label="Breadcrumb">
                    <ol class="inline-flex items-center space-x-1 md:space-x-3">
                        <li class="inline-flex items-center">
                            <a href="{% url 'field_list' %}" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600">
                                <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                Fields & Characteristics
                            </a>
                        </li>
                        <li>
                            <div class="flex items-center">
                                <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                                </svg>
                                <span class="ml-1 text-sm font-medium text-gray-500">{{ page_title }}</span>
                            </div>
                        </li>
                    </ol>
                </nav>
                <h1 class="text-3xl font-bold text-gray-900 mt-2 flex items-center">
                    <svg class="w-8 h-8 text-blue-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="{% if is_editing %}M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z{% else %}M12 6v6m0 0v6m0-6h6m-6 0H6{% endif %}"/>
                    </svg>
                    {{ page_title }}
                </h1>
                {% if is_editing %}
                    <p class="text-gray-600 mt-2">Update the field details below</p>
                {% else %}
                    <p class="text-gray-600 mt-2">Create a new data field for councils to populate</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Form Section -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <form method="post" class="divide-y divide-gray-200">
            {% csrf_token %}
            
            <!-- Basic Information -->
            <div class="p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Basic Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Field Name <span class="text-red-500">*</span>
                        </label>
                        {{ form.name }}
                        {% if form.name.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.name.errors.0 }}</div>
                        {% endif %}
                        <p class="mt-1 text-sm text-gray-500">The display name for this field</p>
                    </div>
                    
                    <div>
                        <label for="{{ form.slug.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Slug <span class="text-red-500">*</span>
                        </label>
                        {{ form.slug }}
                        {% if form.slug.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.slug.errors.0 }}</div>
                        {% endif %}
                        <p class="mt-1 text-sm text-gray-500">URL-friendly identifier (auto-generated from name)</p>
                    </div>
                </div>
                
                <div class="mt-6">
                    <label for="{{ form.explanation.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                        Description
                    </label>
                    {{ form.explanation }}
                    {% if form.explanation.errors %}
                        <div class="mt-1 text-sm text-red-600">{{ form.explanation.errors.0 }}</div>
                    {% endif %}
                    <p class="mt-1 text-sm text-gray-500">Detailed explanation of what this field represents</p>
                </div>
            </div>

            <!-- Field Properties -->
            <div class="p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Field Properties</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="{{ form.category.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Category <span class="text-red-500">*</span>
                        </label>
                        {{ form.category }}
                        {% if form.category.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.category.errors.0 }}</div>
                        {% endif %}
                        <p class="mt-1 text-sm text-gray-500">What type of data this field contains</p>
                    </div>
                    
                    <div>
                        <label for="{{ form.content_type.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Data Type <span class="text-red-500">*</span>
                        </label>
                        {{ form.content_type }}
                        {% if form.content_type.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.content_type.errors.0 }}</div>
                        {% endif %}
                        <p class="mt-1 text-sm text-gray-500">The format/type of data stored</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Options</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                {{ form.required }}
                                <span class="ml-2 text-sm text-gray-700">Required Field</span>
                            </label>
                        </div>
                        {% if form.required.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.required.errors.0 }}</div>
                        {% endif %}
                        <p class="mt-1 text-sm text-gray-500">Whether this field must be filled</p>
                    </div>
                </div>
            </div>

            <!-- Formula Builder (for calculated fields) -->
            <div class="p-6" id="formula-section" style="display: none;">
                <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                    <svg class="w-5 h-5 text-purple-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                    </svg>
                    Formula Builder
                </h3>
                
                <!-- Available Fields Panel -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="lg:col-span-1">
                        <h4 class="text-sm font-medium text-gray-900 mb-3">Available Fields</h4>
                        <div class="border border-gray-300 rounded-md bg-gray-50 p-3 max-h-64 overflow-y-auto">
                            <div id="available-fields-list">
                                <div class="text-sm text-gray-500 text-center py-4">Loading available fields...</div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Drag fields into the formula builder</p>
                    </div>
                    
                    <!-- Formula Builder Area -->
                    <div class="lg:col-span-2">
                        <h4 class="text-sm font-medium text-gray-900 mb-3">Formula Builder</h4>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg bg-white p-4 min-h-32" id="formula-drop-zone">
                            <div id="formula-components" class="space-y-2">
                                <div class="text-sm text-gray-500 text-center py-8" id="formula-placeholder">
                                    Drag fields and operators here to build your formula
                                </div>
                            </div>
                        </div>
                        
                        <!-- Operator Buttons -->
                        <div class="mt-4">
                            <h5 class="text-sm font-medium text-gray-700 mb-2">Operators</h5>
                            <div class="flex flex-wrap gap-2">
                                <button type="button" class="operator-btn px-3 py-1 text-sm bg-blue-100 text-blue-800 rounded hover:bg-blue-200" data-operator="+">+ Add</button>
                                <button type="button" class="operator-btn px-3 py-1 text-sm bg-blue-100 text-blue-800 rounded hover:bg-blue-200" data-operator="-">- Subtract</button>
                                <button type="button" class="operator-btn px-3 py-1 text-sm bg-blue-100 text-blue-800 rounded hover:bg-blue-200" data-operator="*">× Multiply</button>
                                <button type="button" class="operator-btn px-3 py-1 text-sm bg-blue-100 text-blue-800 rounded hover:bg-blue-200" data-operator="/">÷ Divide</button>
                                <button type="button" class="operator-btn px-3 py-1 text-sm bg-green-100 text-green-800 rounded hover:bg-green-200" data-operator="(">(</button>
                                <button type="button" class="operator-btn px-3 py-1 text-sm bg-green-100 text-green-800 rounded hover:bg-green-200" data-operator=")">)</button>
                                <button type="button" class="clear-formula px-3 py-1 text-sm bg-red-100 text-red-800 rounded hover:bg-red-200">Clear</button>
                            </div>
                        </div>
                        
                        <!-- Formula Preview -->
                        <div class="mt-4 p-3 bg-gray-50 border border-gray-200 rounded">
                            <h5 class="text-sm font-medium text-gray-700 mb-1">Formula Preview:</h5>
                            <code id="formula-preview" class="text-sm text-gray-900">No formula built yet</code>
                        </div>
                        
                        <!-- Validation Status -->
                        <div id="formula-validation" class="mt-3" style="display: none;">
                            <div class="flex items-center p-3 rounded-md" id="validation-message">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20" id="validation-icon">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                                <span id="validation-text"></span>
                            </div>
                        </div>
                        
                        <!-- Formula Testing -->
                        <div class="mt-4">
                            <div class="flex items-center space-x-3 mb-3">
                                <div>
                                    <label for="test-council-select" class="block text-sm font-medium text-gray-700 mb-1">Test Council</label>
                                    <select id="test-council-select" class="px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                        <option value="">Use sample data</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="test-year-select" class="block text-sm font-medium text-gray-700 mb-1">Test Year</label>
                                    <select id="test-year-select" class="px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                        <option value="">Latest year</option>
                                    </select>
                                </div>
                            </div>
                            <button type="button" id="test-formula-btn" class="px-4 py-2 text-sm bg-purple-600 text-white rounded hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                Test Formula
                            </button>
                            <div id="formula-test-results" class="mt-3" style="display: none;">
                                <div class="p-3 bg-gray-50 border border-gray-200 rounded">
                                    <h6 class="text-sm font-medium text-gray-900 mb-2">Test Results</h6>
                                    <div id="test-results-content"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Hidden formula field -->
                <div style="display: none;">
                    {{ form.formula }}
                </div>
                {% if form.formula.errors %}
                    <div class="mt-1 text-sm text-red-600">{{ form.formula.errors.0 }}</div>
                {% endif %}
            </div>

            <!-- Advanced Options -->
            <div class="p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Advanced Options</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div id="manual-formula-section">
                        <label for="{{ form.formula.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Manual Formula
                        </label>
                        <input type="text" id="manual-formula-input" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter formula manually (for non-calculated fields)">
                        <p class="mt-1 text-sm text-gray-500">Manual formula entry for non-calculated fields</p>
                    </div>
                    
                    <div>
                        <label for="{{ form.council_types.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Applicable Council Types
                        </label>
                        {{ form.council_types }}
                        {% if form.council_types.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.council_types.errors.0 }}</div>
                        {% endif %}
                        <p class="mt-1 text-sm text-gray-500">Leave empty to apply to all council types</p>
                    </div>
                </div>
                
                {% if form.dataset_type %}
                <div class="mt-6">
                    <label for="{{ form.dataset_type.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                        Dataset Type
                    </label>
                    {{ form.dataset_type }}
                    {% if form.dataset_type.errors %}
                        <div class="mt-1 text-sm text-red-600">{{ form.dataset_type.errors.0 }}</div>
                    {% endif %}
                    <p class="mt-1 text-sm text-gray-500">For list fields, specify the model providing options</p>
                </div>
                {% endif %}
            </div>

            <!-- Form Actions -->
            <div class="px-6 py-4 bg-gray-50 flex items-center justify-between">
                <a href="{% url 'field_list' %}" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Cancel
                </a>
                <div class="flex space-x-3">
                    {% if is_editing %}
                        <a href="{% url 'field_delete' field.id %}" class="px-4 py-2 text-sm font-medium text-white bg-red-600 border border-transparent rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                            Delete Field
                        </a>
                    {% endif %}
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        {% if is_editing %}Update Field{% else %}Create Field{% endif %}
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
// Smart Field Form Management
class SmartFieldForm {
    constructor() {
        this.availableFields = [];
        this.formulaComponents = [];
        this.isCalculatedField = false;
        
        this.init();
    }
    
    init() {
        this.setupCategoryWatcher();
        this.setupSlugGenerator();
        this.loadAvailableFields();
        this.setupFormulaBuilder();
        this.setupTestDropdowns();
        this.setupTestButton();
        this.setupFormValidation();
    }
    
    setupCategoryWatcher() {
        const categorySelect = document.getElementById('id_category');
        if (categorySelect) {
            categorySelect.addEventListener('change', (e) => {
                this.handleCategoryChange(e.target.value);
            });
            
            // Initialize on page load
            this.handleCategoryChange(categorySelect.value);
        }
    }
    
    handleCategoryChange(category) {
        const formulaSection = document.getElementById('formula-section');
        const manualFormulaSection = document.getElementById('manual-formula-section');
        
        if (category === 'calculated') {
            this.isCalculatedField = true;
            formulaSection.style.display = 'block';
            manualFormulaSection.style.display = 'none';
            this.showValidationWarning();
        } else {
            this.isCalculatedField = false;
            formulaSection.style.display = 'none';
            manualFormulaSection.style.display = 'block';
            this.hideValidationWarning();
        }
    }
    
    showValidationWarning() {
        const warning = document.createElement('div');
        warning.id = 'calculated-field-warning';
        warning.className = 'mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg';
        warning.innerHTML = `
            <div class="flex">
                <svg class="w-5 h-5 text-yellow-400 mr-3 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
                <div>
                    <h4 class="text-sm font-medium text-yellow-800">Calculated Field Requirements</h4>
                    <p class="text-sm text-yellow-700 mt-1">Calculated fields require a valid formula using existing fields. All referenced fields must exist before this field can be created.</p>
                </div>
            </div>
        `;
        
        const formulaSection = document.getElementById('formula-section');
        if (!document.getElementById('calculated-field-warning')) {
            formulaSection.insertBefore(warning, formulaSection.firstChild);
        }
    }
    
    hideValidationWarning() {
        const warning = document.getElementById('calculated-field-warning');
        if (warning) {
            warning.remove();
        }
    }
    
    setupSlugGenerator() {
        const nameInput = document.getElementById('id_name');
        const slugInput = document.getElementById('id_slug');
        
        if (nameInput && slugInput) {
            nameInput.addEventListener('input', (e) => {
                // Only auto-generate if slug is empty or this is a new field
                const isEditing = {% if is_editing %}true{% else %}false{% endif %};
                if (!slugInput.value || !isEditing) {
                    const slug = e.target.value
                        .toLowerCase()
                        .replace(/[^a-z0-9\s-]/g, '')
                        .replace(/\s+/g, '-')
                        .replace(/-+/g, '-')
                        .trim('-');
                    slugInput.value = slug;
                }
            });
        }
    }
    
    async loadAvailableFields() {
        try {
            const response = await fetch('/api/factoid/templates/discover_fields/');
            const data = await response.json();
            
            console.log('API response:', data);
            
            if (data.success && data.field_groups) {
                this.availableFields = [];
                Object.keys(data.field_groups).forEach(category => {
                    data.field_groups[category].forEach(field => {
                        this.availableFields.push({
                            ...field,
                            category: category
                        });
                    });
                });
                
                console.log('Loaded fields:', this.availableFields.length);
                this.renderAvailableFields();
            } else {
                console.error('Invalid API response structure:', data);
                this.showFieldLoadError();
            }
        } catch (error) {
            console.error('Failed to load available fields:', error);
            this.showFieldLoadError();
        }
    }
    
    renderAvailableFields() {
        const container = document.getElementById('available-fields-list');
        if (!container) {
            console.error('available-fields-list container not found');
            return;
        }
        
        console.log('Rendering', this.availableFields.length, 'available fields');
        
        // Group fields by category
        const groupedFields = {};
        this.availableFields.forEach(field => {
            if (!groupedFields[field.category]) {
                groupedFields[field.category] = [];
            }
            groupedFields[field.category].push(field);
        });
        
        let html = '';
        Object.keys(groupedFields).forEach(category => {
            const categoryName = category.charAt(0).toUpperCase() + category.slice(1).replace('_', ' ');
            html += `
                <div class="mb-3">
                    <h5 class="text-xs font-semibold text-gray-700 uppercase tracking-wide mb-1">${categoryName}</h5>
                    <div class="space-y-1">
            `;
            
            groupedFields[category].forEach(field => {
                const colorClass = this.getCategoryColor(field.category);
                html += `
                    <div class="field-item p-2 bg-white border border-gray-200 rounded cursor-move hover:bg-gray-50 transition-colors" 
                         draggable="true" 
                         data-field-id="${field.id}" 
                         data-field-name="${field.variable_name}"
                         data-field-display="${field.name}">
                        <div class="flex items-center">
                            <span class="inline-block w-2 h-2 rounded-full ${colorClass} mr-2 flex-shrink-0"></span>
                            <div class="flex-1 min-w-0">
                                <div class="text-xs font-medium text-gray-900 truncate">${field.name}</div>
                                <div class="text-xs text-gray-500 truncate">${field.variable_name}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        this.setupFieldDragHandlers();
    }
    
    getCategoryColor(category) {
        const colors = {
            'characteristic': 'bg-purple-400',
            'balance_sheet': 'bg-blue-400',
            'income': 'bg-green-400',
            'spending': 'bg-red-400',
            'calculated': 'bg-yellow-400',
            'general': 'bg-gray-400'
        };
        return colors[category] || 'bg-gray-400';
    }
    
    showFieldLoadError() {
        const container = document.getElementById('available-fields-list');
        if (container) {
            container.innerHTML = `
                <div class="text-center py-4">
                    <div class="text-red-500 text-sm">Failed to load fields</div>
                    <button class="text-xs text-blue-600 hover:text-blue-800 mt-1" onclick="smartForm.loadAvailableFields()">Retry</button>
                </div>
            `;
        }
    }
    
    setupFormulaBuilder() {
        const dropZone = document.getElementById('formula-drop-zone');
        if (!dropZone) return;
        
        // Setup drop zone
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-blue-400', 'bg-blue-50');
        });
        
        dropZone.addEventListener('dragleave', (e) => {
            if (!dropZone.contains(e.relatedTarget)) {
                dropZone.classList.remove('border-blue-400', 'bg-blue-50');
            }
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-400', 'bg-blue-50');
            
            const fieldName = e.dataTransfer.getData('text/field-name');
            const fieldDisplay = e.dataTransfer.getData('text/field-display');
            
            if (fieldName && fieldDisplay) {
                this.addFormulaComponent('field', fieldName, fieldDisplay);
            } else {
                console.warn('Missing field data in drop event:', { fieldName, fieldDisplay });
            }
        });
        
        // Setup operator buttons
        document.querySelectorAll('.operator-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const operator = e.target.dataset.operator;
                if (operator) {
                    this.addFormulaComponent('operator', operator, operator);
                } else {
                    console.error('Missing operator data attribute:', e.target);
                }
            });
        });
        
        // Setup clear button
        const clearBtn = document.querySelector('.clear-formula');
        if (clearBtn) {
            clearBtn.addEventListener('click', () => {
                this.clearFormula();
            });
        }
    }
    
    setupFieldDragHandlers() {
        const fieldItems = document.querySelectorAll('.field-item');
        console.log('Setting up drag handlers for', fieldItems.length, 'field items');
        
        fieldItems.forEach(item => {
            item.addEventListener('dragstart', (e) => {
                const fieldName = item.dataset.fieldName;
                const fieldDisplay = item.dataset.fieldDisplay;
                
                console.log('Drag start:', { fieldName, fieldDisplay });
                
                if (fieldName && fieldDisplay) {
                    e.dataTransfer.setData('text/field-name', fieldName);
                    e.dataTransfer.setData('text/field-display', fieldDisplay);
                    item.classList.add('opacity-50');
                } else {
                    console.error('Missing field data attributes:', item);
                    e.preventDefault();
                }
            });
            
            item.addEventListener('dragend', (e) => {
                item.classList.remove('opacity-50');
            });
        });
    }
    
    addFormulaComponent(type, value, display) {
        const component = {
            id: Date.now() + Math.random(),
            type: type,
            value: value,
            display: display || value
        };
        
        this.formulaComponents.push(component);
        this.renderFormula();
        this.validateFormula();
    }
    
    removeFormulaComponent(id) {
        this.formulaComponents = this.formulaComponents.filter(c => c.id !== id);
        this.renderFormula();
        this.validateFormula();
    }
    
    renderFormula() {
        const container = document.getElementById('formula-components');
        if (!container) return;
        
        if (this.formulaComponents.length === 0) {
            container.innerHTML = '<div class="text-sm text-gray-500 text-center py-8" id="formula-placeholder">Drag fields and operators here to build your formula</div>';
            this.updateFormulaPreview('');
            return;
        }
        
        let html = '<div class="flex flex-wrap items-center gap-2">';
        this.formulaComponents.forEach(component => {
            const colorClass = component.type === 'field' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800';
            html += `
                <span class="inline-flex items-center px-2 py-1 rounded text-sm ${colorClass}">
                    ${component.display}
                    <button type="button" class="ml-1 text-xs hover:text-red-600" onclick="smartForm.removeFormulaComponent(${component.id})">×</button>
                </span>
            `;
        });
        html += '</div>';
        
        container.innerHTML = html;
        
        // Update formula preview
        const formulaText = this.formulaComponents.map(c => c.value).join(' ');
        this.updateFormulaPreview(formulaText);
        
        // Update hidden form field
        const hiddenField = document.getElementById('id_formula');
        if (hiddenField) {
            hiddenField.value = formulaText;
        }
    }
    
    updateFormulaPreview(formula) {
        const preview = document.getElementById('formula-preview');
        if (preview) {
            preview.textContent = formula || 'No formula built yet';
        }
    }
    
    clearFormula() {
        this.formulaComponents = [];
        this.renderFormula();
        this.validateFormula();
    }
    
    async validateFormula() {
        if (!this.isCalculatedField || this.formulaComponents.length === 0) {
            this.hideValidation();
            return;
        }
        
        const formula = this.formulaComponents.map(c => c.value).join(' ');
        
        try {
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const fieldId = {% if field and field.id %}{{ field.id|escapejs }}{% else %}null{% endif %};
            
            // Call server-side validation API
            const response = await fetch('{% url "validate_formula_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: new URLSearchParams({
                    formula: formula,
                    field_id: fieldId || ''
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                if (data.valid) {
                    this.showValidation(true, 'Formula is valid');
                    this.enableTestButton();
                } else {
                    this.showValidation(false, data.errors.join(', '));
                    this.disableTestButton();
                }
            } else {
                this.showValidation(false, 'Validation error: ' + (data.error || 'Unknown error'));
                this.disableTestButton();
            }
            
        } catch (error) {
            console.error('Formula validation error:', error);
            // Fallback to client-side validation
            this.clientSideValidation(formula);
        }
    }
    
    clientSideValidation(formula) {
        const referencedFields = this.formulaComponents
            .filter(c => c.type === 'field')
            .map(c => c.value);
        
        // Check if all referenced fields exist
        const missingFields = referencedFields.filter(fieldName => {
            return !this.availableFields.some(f => f.variable_name === fieldName);
        });
        
        if (missingFields.length > 0) {
            this.showValidation(false, `Missing fields: ${missingFields.join(', ')}`);
            return;
        }
        
        // Basic syntax validation
        if (!this.isValidFormulaSyntax(formula)) {
            this.showValidation(false, 'Invalid formula syntax');
            return;
        }
        
        this.showValidation(true, 'Formula appears valid (client-side check)');
    }
    
    isValidFormulaSyntax(formula) {
        // Basic syntax checks
        if (!formula.trim()) return false;
        
        // Check balanced parentheses
        let depth = 0;
        for (let char of formula) {
            if (char === '(') depth++;
            if (char === ')') depth--;
            if (depth < 0) return false;
        }
        
        return depth === 0;
    }
    
    showValidation(isValid, message) {
        const validation = document.getElementById('formula-validation');
        const messageDiv = document.getElementById('validation-message');
        const icon = document.getElementById('validation-icon');
        const text = document.getElementById('validation-text');
        
        if (validation && messageDiv && icon && text) {
            validation.style.display = 'block';
            text.textContent = message;
            
            if (isValid) {
                messageDiv.className = 'flex items-center p-3 rounded-md bg-green-50 border border-green-200';
                // Use setAttribute for SVG elements
                icon.setAttribute('class', 'w-4 h-4 mr-2 text-green-600');
                icon.innerHTML = '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>';
            } else {
                messageDiv.className = 'flex items-center p-3 rounded-md bg-red-50 border border-red-200';
                // Use setAttribute for SVG elements
                icon.setAttribute('class', 'w-4 h-4 mr-2 text-red-600');
                icon.innerHTML = '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>';
            }
        }
    }
    
    hideValidation() {
        const validation = document.getElementById('formula-validation');
        if (validation) {
            validation.style.display = 'none';
        }
    }
    
    enableTestButton() {
        const testBtn = document.getElementById('test-formula-btn');
        if (testBtn) {
            testBtn.disabled = false;
        }
    }
    
    disableTestButton() {
        const testBtn = document.getElementById('test-formula-btn');
        if (testBtn) {
            testBtn.disabled = true;
        }
    }
    
    async setupTestDropdowns() {
        // Populate council dropdown
        try {
            const councilSelect = document.getElementById('test-council-select');
            const yearSelect = document.getElementById('test-year-select');
            
            if (!councilSelect || !yearSelect) return;
            
            // Load councils from the existing context or make an API call
            // For now, we'll use a simple approach by extracting from template context
            const councils = {{ councils_json|default:"[]"|safe }};
            const years = {{ years_json|default:"[]"|safe }};
            
            // Clear existing options (except default)
            councilSelect.innerHTML = '<option value="">Use sample data</option>';
            yearSelect.innerHTML = '<option value="">Latest year</option>';
            
            // Populate councils
            if (Array.isArray(councils)) {
                councils.forEach(council => {
                    const option = document.createElement('option');
                    option.value = council.slug;
                    option.textContent = council.name;
                    councilSelect.appendChild(option);
                });
            }
            
            // Populate years  
            if (Array.isArray(years)) {
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year.label;
                    option.textContent = year.display_label || year.label;
                    yearSelect.appendChild(option);
                });
            }
            
        } catch (error) {
            console.error('Error setting up test dropdowns:', error);
        }
    }
    
    setupTestButton() {
        const testBtn = document.getElementById('test-formula-btn');
        if (testBtn) {
            testBtn.addEventListener('click', () => {
                this.testFormula();
            });
        }
    }
    
    async testFormula() {
        const formula = this.formulaComponents.map(c => c.value).join(' ');
        const resultsDiv = document.getElementById('formula-test-results');
        const contentDiv = document.getElementById('test-results-content');
        const councilSelect = document.getElementById('test-council-select');
        const yearSelect = document.getElementById('test-year-select');
        
        if (!formula.trim()) {
            return;
        }
        
        try {
            resultsDiv.style.display = 'block';
            contentDiv.innerHTML = '<div class="text-sm text-gray-500">Testing formula...</div>';
            
            // Build query parameters
            const params = new URLSearchParams({
                formula: formula
            });
            
            if (councilSelect && councilSelect.value) {
                params.append('council_slug', councilSelect.value);
            }
            
            if (yearSelect && yearSelect.value) {
                params.append('year', yearSelect.value);
            }
            
            const response = await fetch(`{% url "test_formula_api" %}?${params.toString()}`);
            const data = await response.json();
            
            if (data.success) {
                contentDiv.innerHTML = `
                    <div class="space-y-2">
                        <div class="text-sm">
                            <span class="font-medium text-green-600">✓ Test Successful</span>
                        </div>
                        <div class="text-sm">
                            <strong>Result:</strong> ${data.result}
                        </div>
                        <div class="text-sm">
                            <strong>Field Values Used:</strong>
                            <ul class="ml-4 mt-1">
                                ${Object.entries(data.field_values || {}).map(([field, value]) => 
                                    `<li>${field}: ${value}</li>`
                                ).join('')}
                            </ul>
                        </div>
                        <div class="text-xs text-gray-500">
                            Evaluated: ${data.evaluated_formula || formula}
                        </div>
                    </div>
                `;
            } else {
                contentDiv.innerHTML = `
                    <div class="space-y-2">
                        <div class="text-sm">
                            <span class="font-medium text-red-600">✗ Test Failed</span>
                        </div>
                        <div class="text-sm text-red-600">
                            ${data.error || 'Unknown error'}
                        </div>
                        ${data.field_values ? `
                            <div class="text-sm">
                                <strong>Field Values:</strong>
                                <ul class="ml-4 mt-1">
                                    ${Object.entries(data.field_values).map(([field, value]) => 
                                        `<li>${field}: ${value}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
        } catch (error) {
            console.error('Formula test error:', error);
            contentDiv.innerHTML = `
                <div class="text-sm text-red-600">
                    Error testing formula: ${error.message}
                </div>
            `;
        }
    }
    
    setupFormValidation() {
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', (e) => {
                if (this.isCalculatedField && this.formulaComponents.length === 0) {
                    e.preventDefault();
                    alert('Calculated fields require a formula. Please build a formula using the drag-and-drop interface.');
                    return false;
                }
                
                // Update manual formula field
                const manualFormulaInput = document.getElementById('manual-formula-input');
                const hiddenFormulaField = document.getElementById('id_formula');
                
                if (!this.isCalculatedField && manualFormulaInput && hiddenFormulaField) {
                    hiddenFormulaField.value = manualFormulaInput.value;
                }
            });
        }
    }
}

// Initialize the smart form
let smartForm;
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing SmartFieldForm');
    try {
        smartForm = new SmartFieldForm();
        console.log('SmartFieldForm initialized successfully');
    } catch (error) {
        console.error('Error initializing SmartFieldForm:', error);
    }
});
</script>
{% endblock %}