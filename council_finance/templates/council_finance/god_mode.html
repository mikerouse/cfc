{% extends "base.html" %}
{% load static %}
{% block title %}Zeus Surveillance Mode - Council Finance Counters{% endblock %}
{% block content %}
<div class="max-w-7xl mx-auto">
  <!-- Zeus Header -->
  <div class="mb-8 bg-gradient-to-r from-purple-900 via-blue-900 to-indigo-900 rounded-lg p-6 text-white">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-4xl font-bold mb-2">‚ö° Zeus Surveillance Mode ‚ö°</h1>
        <p class="text-blue-200">Omniscient oversight of all system activity - See all, know all</p>
        <p class="text-xs text-blue-300 mt-1">üèõÔ∏è Atop digital Olympus, watching over all of Council Finance Greece</p>
      </div>
      <div class="text-6xl opacity-50">üëÅÔ∏è</div>
    </div>
  </div>

  <!-- Real-Time Alerts Dashboard -->
  {% if active_alerts %}
  <div class="mb-6 p-4 bg-red-50 border-l-4 border-red-500 rounded-r-lg">
    <div class="flex items-center mb-2">
      <h2 class="text-lg font-semibold text-red-800">‚ö†Ô∏è Active Divine Alerts</h2>
      <span class="ml-2 px-2 py-1 bg-red-200 text-red-800 text-xs rounded-full">{{ active_alerts|length }}</span>
    </div>
    <div class="space-y-2">
      {% for alert in active_alerts %}
      <div class="flex items-center justify-between p-2 bg-white rounded border-l-2 border-red-300">
        <div class="flex items-center">
          <span class="text-lg mr-2">{{ alert.icon }}</span>
          <div>
            <span class="font-medium text-red-800">{{ alert.title }}</span>
            <p class="text-sm text-red-600">{{ alert.message }}</p>
          </div>
        </div>
        <span class="text-xs text-red-500">{{ alert.level|upper }}</span>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Surveillance Grid Layout -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    
    <!-- Left Column: Real-Time Activity Surveillance -->
    <div class="lg:col-span-1 space-y-6">
      
      <!-- Active User Surveillance -->
      <div class="bg-white rounded-lg shadow-sm border border-blue-200">
        <div class="p-4 border-b border-gray-200 bg-blue-50">
          <h2 class="text-lg font-semibold text-blue-900 flex items-center">
            <span class="mr-2">üë•</span>User Activity Surveillance
          </h2>
        </div>
        <div class="p-4">
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium text-gray-700">Active Users (24h)</span>
              <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-sm">
                {{ user_activity_surveillance.active_users_24h }}
              </span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium text-gray-700">New Contributions Today</span>
              <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">
                {{ user_activity_surveillance.contributions_today }}
              </span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium text-gray-700">Suspicious Activity</span>
              <span class="px-2 py-1 bg-{% if user_activity_surveillance.suspicious_activity_count > 0 %}red{% else %}gray{% endif %}-100 text-{% if user_activity_surveillance.suspicious_activity_count > 0 %}red{% else %}gray{% endif %}-800 rounded-full text-sm">
                {{ user_activity_surveillance.suspicious_activity_count }}
              </span>
            </div>
          </div>
          
          <!-- High Activity Users -->
          {% if high_activity_users %}
          <div class="mt-4 pt-4 border-t border-gray-200">
            <h4 class="text-sm font-medium text-gray-700 mb-2">üî• High Activity Users</h4>
            <div class="space-y-2">
              {% for user in high_activity_users %}
              <div class="flex items-center justify-between text-xs">
                <span class="font-medium">{{ user.username }}</span>
                <span class="text-gray-500">{{ user.activity_count }} actions</span>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Data Quality Surveillance -->
      <div class="bg-white rounded-lg shadow-sm border border-yellow-200">
        <div class="p-4 border-b border-gray-200 bg-yellow-50">
          <h2 class="text-lg font-semibold text-yellow-900 flex items-center">
            <span class="mr-2">üìä</span>Data Quality Surveillance
          </h2>
        </div>
        <div class="p-4">
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium text-gray-700">Data Completeness</span>
              <div class="flex items-center">
                <div class="w-20 bg-gray-200 rounded-full h-2 mr-2">
                  <div class="bg-{% if data_quality_surveillance.completeness_percentage >= 80 %}green{% elif data_quality_surveillance.completeness_percentage >= 60 %}yellow{% else %}red{% endif %}-500 h-2 rounded-full" 
                       style="width: {{ data_quality_surveillance.completeness_percentage }}%"></div>
                </div>
                <span class="text-sm">{{ data_quality_surveillance.completeness_percentage|floatformat:0 }}%</span>
              </div>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium text-gray-700">Missing Data Issues</span>
              <span class="px-2 py-1 bg-{% if data_quality_surveillance.missing_data_issues > 0 %}orange{% else %}gray{% endif %}-100 text-{% if data_quality_surveillance.missing_data_issues > 0 %}orange{% else %}gray{% endif %}-800 rounded-full text-sm">
                {{ data_quality_surveillance.missing_data_issues }}
              </span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium text-gray-700">Data Consistency Score</span>
              <span class="px-2 py-1 bg-{% if data_quality_surveillance.consistency_score >= 80 %}green{% elif data_quality_surveillance.consistency_score >= 60 %}yellow{% else %}red{% endif %}-100 text-{% if data_quality_surveillance.consistency_score >= 80 %}green{% elif data_quality_surveillance.consistency_score >= 60 %}yellow{% else %}red{% endif %}-800 rounded-full text-sm">
                {{ data_quality_surveillance.consistency_score|floatformat:0 }}%
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Security Monitoring -->
      <div class="bg-white rounded-lg shadow-sm border border-red-200">
        <div class="p-4 border-b border-gray-200 bg-red-50">
          <h2 class="text-lg font-semibold text-red-900 flex items-center">
            <span class="mr-2">üõ°Ô∏è</span>Security Surveillance
          </h2>
        </div>
        <div class="p-4">
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium text-gray-700">Bulk Operations (24h)</span>
              <span class="px-2 py-1 bg-{% if security_monitoring.bulk_operations_24h > 5 %}red{% elif security_monitoring.bulk_operations_24h > 0 %}yellow{% else %}gray{% endif %}-100 text-{% if security_monitoring.bulk_operations_24h > 5 %}red{% elif security_monitoring.bulk_operations_24h > 0 %}yellow{% else %}gray{% endif %}-800 rounded-full text-sm">
                {{ security_monitoring.bulk_operations_24h }}
              </span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium text-gray-700">Admin Activities (24h)</span>
              <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">
                {{ security_monitoring.admin_activities_24h }}
              </span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium text-gray-700">Unusual Patterns</span>
              <span class="px-2 py-1 bg-{% if security_monitoring.unusual_patterns > 0 %}orange{% else %}gray{% endif %}-100 text-{% if security_monitoring.unusual_patterns > 0 %}orange{% else %}gray{% endif %}-800 rounded-full text-sm">
                {{ security_monitoring.unusual_patterns }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Center Column: Council Activity & Recent Events -->
    <div class="lg:col-span-1 space-y-6">
      
      <!-- Council Activity Hotspots -->
      <div class="bg-white rounded-lg shadow-sm border border-green-200">
        <div class="p-4 border-b border-gray-200 bg-green-50">
          <h2 class="text-lg font-semibold text-green-900 flex items-center">
            <span class="mr-2">üèõÔ∏è</span>Council Activity Hotspots
          </h2>
        </div>
        <div class="p-4">
          {% if council_activity_hotspots %}
          <div class="space-y-3">
            {% for council in council_activity_hotspots %}
            <div class="flex items-center justify-between p-2 bg-green-50 rounded">
              <div>
                <div class="font-medium text-sm">{{ council.name|truncatechars:25 }}</div>
                <div class="text-xs text-gray-500">{{ council.recent_activity }} recent activities</div>
              </div>
              <div class="flex items-center">
                <div class="w-12 bg-gray-200 rounded-full h-2 mr-2">
                  <div class="bg-green-500 h-2 rounded-full" style="width: {{ council.activity_percentage }}%"></div>
                </div>
                <span class="text-xs text-green-700">{{ council.activity_percentage }}%</span>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-center py-4 text-gray-500">
            <div class="text-2xl mb-2">üèõÔ∏è</div>
            <p class="text-sm">No recent council activity detected</p>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Recent Rejections Surveillance -->
      <div class="bg-white rounded-lg shadow-sm border border-purple-200">
        <div class="p-4 border-b border-gray-200 bg-purple-50">
          <h2 class="text-lg font-semibold text-purple-900 flex items-center">
            <span class="mr-2">‚ùå</span>Recent Rejections
          </h2>
        </div>
        <div class="p-4">
          {% if recent_rejections %}
          <div class="space-y-3">
            {% for rejection in recent_rejections %}
            <div class="border-l-4 border-red-300 pl-3 py-2">
              <div class="flex items-center justify-between">
                <div class="text-sm font-medium">
                  {{ rejection.council.name|truncatechars:20 }}
                </div>
                <div class="text-xs text-gray-500">
                  {{ rejection.created_at|timesince }} ago
                </div>
              </div>
              <div class="text-xs text-gray-600 mt-1">
                Field: {{ rejection.field_name }}
              </div>
              {% if rejection.reviewed_by %}
              <div class="text-xs text-purple-600">
                Reviewed by: {{ rejection.reviewed_by.username }}
              </div>
              {% endif %}
              {% if rejection.reason %}
              <div class="text-xs text-red-600 mt-1">
                "{{ rejection.reason|truncatechars:50 }}"
              </div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-center py-4 text-gray-500">
            <div class="text-2xl mb-2">‚úÖ</div>
            <p class="text-sm">No recent rejections - All is well!</p>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Financial Year Management -->
      <div class="bg-white rounded-lg shadow-sm border border-indigo-200">
        <div class="p-4 border-b border-gray-200 bg-indigo-50">
          <h2 class="text-lg font-semibold text-indigo-900 flex items-center">
            <span class="mr-2">üìÖ</span>Financial Years
          </h2>
        </div>
        <div class="p-4">
          <!-- Add New Year -->
          <form method="post" class="mb-4">
            {% csrf_token %}
            <div class="space-y-2">
              <div class="flex gap-2">
                <input type="text" name="new_year_label" 
                       placeholder="{% if recommended_year %}{{ recommended_year }}{% else %}e.g., 2024/25{% endif %}" 
                       value="{% if recommended_year %}{{ recommended_year }}{% endif %}"
                       class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                <button type="submit" name="add_financial_year" value="1"
                        class="px-3 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 text-sm">
                  Add
                </button>
              </div>
              {% if recommended_year %}
              <p class="text-xs text-gray-500">
                üí° Suggested: <strong>{{ recommended_year }}</strong>
              </p>
              {% endif %}
            </div>
          </form>
          
          <!-- Current Years List -->
          <div class="space-y-2 max-h-64 overflow-y-auto">
            {% for year in financial_years %}
            <div class="flex flex-col p-3 bg-gray-50 rounded-md border">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <span class="font-medium text-sm">{{ year.label }}</span>
                  {% if year.is_current %}
                  <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Current</span>
                  {% elif year.is_future %}
                  <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">Future</span>
                  {% endif %}
                </div>
                <div class="flex items-center gap-2">
                  <div class="text-xs text-gray-500">
                    {{ year.get_figure_count }} figures
                  </div>
                  <!-- Delete button -->
                  <button onclick="confirmDeleteYear('{{ year.id }}', '{{ year.label }}', {{ year.get_figure_count }})"
                          class="p-1 text-red-600 hover:text-red-800 hover:bg-red-50 rounded transition-colors"
                          title="Delete financial year">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                  </button>
                </div>
              </div>
              {% if year.notes %}
              <div class="mt-1 text-xs text-gray-600">
                {{ year.notes|truncatechars:100 }}
              </div>
              {% endif %}
            </div>
            {% empty %}
            <div class="text-center py-4 text-gray-500">
              <div class="text-xl mb-2">üìÖ</div>
              <p class="text-xs">No financial years defined</p>
            </div>
            {% endfor %}
          </div>
          
          <!-- Hidden Delete Form -->
          <form id="deleteYearForm" method="post" style="display: none;">
            {% csrf_token %}
            <input type="hidden" name="delete_financial_year" value="1">
            <input type="hidden" name="year_id" id="deleteYearId">
            <input type="hidden" name="confirm_deletion" id="deleteYearConfirm">
          </form>
        </div>
      </div>
    </div>
    
    <!-- Right Column: Divine Actions & System Controls -->
    <div class="lg:col-span-1 space-y-6">
      
      <!-- Divine Commands -->
      <div class="bg-white rounded-lg shadow-sm border border-purple-200">
        <div class="p-4 border-b border-gray-200 bg-gradient-to-r from-purple-50 to-indigo-50">
          <h2 class="text-lg font-semibold text-purple-900 flex items-center">
            <span class="mr-2">‚ö°</span>Divine Commands
          </h2>
        </div>
        <div class="p-4">
          <div class="space-y-3">
            <form method="post" class="w-full">
              {% csrf_token %}
              <button name="assess_issues" value="1" 
                      class="w-full inline-flex items-center justify-center px-4 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
                Assess Data Issues
              </button>
            </form>
            
            <form method="post" class="w-full">
              {% csrf_token %}
              <button name="reconcile_population" value="1" 
                      class="w-full inline-flex items-center justify-center px-4 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Reconcile Population
              </button>
            </form>
            
            <form method="get" class="w-full">
              <button name="export" value="csv" 
                      class="w-full inline-flex items-center justify-center px-4 py-3 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                Export Divine Records
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- System Health Monitoring -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="p-4 border-b border-gray-200 bg-gray-50">
          <h2 class="text-lg font-semibold text-gray-900 flex items-center">
            <span class="mr-2">üíì</span>System Health
          </h2>
        </div>
        <div class="p-4">
          <div class="space-y-4">
            <!-- Database Health -->
            <div class="flex items-center justify-between">
              <span class="text-sm font-medium text-gray-700">Database Health</span>
              <div class="flex items-center">
                <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                <span class="text-sm text-green-700">Healthy</span>
              </div>
            </div>
            
            <!-- Active Sessions -->
            <div class="flex items-center justify-between">
              <span class="text-sm font-medium text-gray-700">Active Sessions</span>
              <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">
                {{ user_activity_surveillance.active_users_24h }}
              </span>
            </div>
            
            <!-- Data Integrity -->
            <div class="flex items-center justify-between">
              <span class="text-sm font-medium text-gray-700">Data Integrity</span>
              <div class="flex items-center">
                <div class="w-3 h-3 bg-{% if data_quality_surveillance.consistency_score >= 80 %}green{% elif data_quality_surveillance.consistency_score >= 60 %}yellow{% else %}red{% endif %}-500 rounded-full mr-2"></div>
                <span class="text-sm">{{ data_quality_surveillance.consistency_score|floatformat:0 }}%</span>
              </div>
            </div>
            
            <!-- Recent Errors -->
            <div class="flex items-center justify-between">
              <span class="text-sm font-medium text-gray-700">Recent Errors</span>
              <span class="px-2 py-1 bg-{% if recent_rejections|length > 0 %}red{% else %}gray{% endif %}-100 text-{% if recent_rejections|length > 0 %}red{% else %}gray{% endif %}-800 rounded-full text-sm">
                {{ recent_rejections|length }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent System Activity -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="p-4 border-b border-gray-200 bg-gray-50">
          <h2 class="text-lg font-semibold text-gray-900 flex items-center">
            <span class="mr-2">üìà</span>Activity Feed
          </h2>
        </div>
        <div class="p-4">
          <div class="space-y-3 max-h-64 overflow-y-auto">
            <!-- Mock recent activities -->
            <div class="flex items-start space-x-2 text-xs">
              <div class="w-2 h-2 bg-blue-500 rounded-full mt-1.5"></div>
              <div>
                <div class="font-medium">New submission received</div>
                <div class="text-gray-500">Council data updated - 2 minutes ago</div>
              </div>
            </div>
            
            <div class="flex items-start space-x-2 text-xs">
              <div class="w-2 h-2 bg-green-500 rounded-full mt-1.5"></div>
              <div>
                <div class="font-medium">Data validation completed</div>
                <div class="text-gray-500">Quality check passed - 5 minutes ago</div>
              </div>
            </div>
            
            <div class="flex items-start space-x-2 text-xs">
              <div class="w-2 h-2 bg-yellow-500 rounded-full mt-1.5"></div>
              <div>
                <div class="font-medium">User logged in</div>
                <div class="text-gray-500">High-privilege access detected - 8 minutes ago</div>
              </div>
            </div>
            
            {% for rejection in recent_rejections|slice:":3" %}
            <div class="flex items-start space-x-2 text-xs">
              <div class="w-2 h-2 bg-red-500 rounded-full mt-1.5"></div>
              <div>
                <div class="font-medium">Data rejected</div>
                <div class="text-gray-500">{{ rejection.council.name|truncatechars:20 }} - {{ rejection.created_at|timesince }} ago</div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="p-4 border-b border-gray-200 bg-gray-50">
          <h2 class="text-lg font-semibold text-gray-900 flex items-center">
            <span class="mr-2">üìä</span>Quick Stats
          </h2>
        </div>
        <div class="p-4">
          <div class="grid grid-cols-2 gap-4 text-center">
            <div class="p-3 bg-blue-50 rounded">
              <div class="text-2xl font-bold text-blue-600">{{ all_councils|length }}</div>
              <div class="text-xs text-blue-700">Total Councils</div>
            </div>
            <div class="p-3 bg-green-50 rounded">
              <div class="text-2xl font-bold text-green-600">{{ financial_years|length }}</div>
              <div class="text-xs text-green-700">Financial Years</div>
            </div>
            <div class="p-3 bg-yellow-50 rounded">
              <div class="text-2xl font-bold text-yellow-600">{{ user_activity_surveillance.contributions_today }}</div>
              <div class="text-xs text-yellow-700">Today's Updates</div>
            </div>
            <div class="p-3 bg-purple-50 rounded">
              <div class="text-2xl font-bold text-purple-600">{{ data_quality_surveillance.completeness_percentage|floatformat:0 }}%</div>
              <div class="text-xs text-purple-700">Data Complete</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer: Zeus Wisdom -->
  <div class="mt-8 p-4 bg-gradient-to-r from-indigo-100 to-purple-100 rounded-lg border border-indigo-200">
    <div class="flex items-center justify-center">
      <div class="text-center">
        <div class="text-2xl mb-2">üèõÔ∏è‚ö°üëÅÔ∏è</div>
        <p class="text-indigo-800 font-medium">"From digital Olympus, Zeus sees all"</p>
        <p class="text-indigo-600 text-sm mt-1">
          Surveillance active across {{ all_councils|length }} councils ‚Ä¢ 
          {{ user_activity_surveillance.active_users_24h }} mortals under watch ‚Ä¢ 
          Data integrity at {{ data_quality_surveillance.consistency_score|floatformat:0 }}%
        </p>
      </div>
    </div>
  </div>
</div>

<script>
function confirmDeleteYear(yearId, yearLabel, figureCount) {
    // Safety check for years with data
    if (figureCount > 0) {
        alert(`‚ö†Ô∏è Cannot delete financial year '${yearLabel}' - it has ${figureCount} associated figure submissions.\n\nTo delete this year, first remove all associated data or contact an administrator.`);
        return;
    }
    
    // Confirmation dialog for years without data
    const confirmed = confirm(
        `üóëÔ∏è Delete Financial Year '${yearLabel}'?\n\n` +
        `This action cannot be undone. The year will be permanently removed from the system.\n\n` +
        `‚úÖ Safe to delete: This year has no associated data.\n\n` +
        `Click OK to proceed with deletion.`
    );
    
    if (confirmed) {
        // Set form values and submit
        document.getElementById('deleteYearId').value = yearId;
        document.getElementById('deleteYearConfirm').value = 'yes';
        document.getElementById('deleteYearForm').submit();
    }
}
</script>

{% endblock %}
