{% extends "council_finance/base.html" %}
{% load static %}
{% load heroicons %}
{% load humanize %}
{% block title %}Leaderboards - Council Finance Counters{% endblock %}

{% block content %}
<div class="mx-auto max-w-none xl:max-w-desktop">
    <!-- Page Header -->
    <div class="mb-8">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-2">Leaderboards</h1>
                <p class="text-gray-600">Rankings for contributions and council financial metrics</p>
            </div>
            
            <!-- Export Controls -->
            {% if not show_contributors and leaderboard_data %}
            <div class="flex items-center gap-2">
                <span class="text-sm text-gray-600">Export:</span>
                {% for format in supported_export_formats %}
                <a href="?{{ request.GET.urlencode }}&export={{ format }}" 
                   class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                    {% if format == 'csv' %}
                        {% heroicon "document-text" size="mini" class="w-4 h-4 mr-1" %}
                    {% elif format == 'xlsx' %}
                        {% heroicon "table-cells" size="mini" class="w-4 h-4 mr-1" %}
                    {% elif format == 'pdf' %}
                        {% heroicon "document" size="mini" class="w-4 h-4 mr-1" %}
                    {% elif format == 'png' %}
                        {% heroicon "chart-bar" size="mini" class="w-4 h-4 mr-1" %}
                    {% endif %}
                    {{ format|upper }}
                </a>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Category Navigation -->
    <div class="mb-8">
        <nav class="flex overflow-x-auto gap-2 pb-2 scrollbar-hide" role="navigation" aria-label="Leaderboard categories">
            {% for cat_key, cat_info in categories.items %}
            <a href="?category={{ cat_key }}{% if per_capita %}&per_capita=true{% endif %}{% if year_label %}&year={{ year_label }}{% endif %}" 
               class="flex-shrink-0 inline-flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-all duration-200 {% if current_category == cat_key %}bg-blue-600 text-white shadow-sm{% else %}bg-white text-gray-700 border border-gray-200 hover:bg-gray-50 hover:border-gray-300{% endif %}"
               {% if current_category == cat_key %}aria-current="page"{% endif %}>
                {% heroicon cat_info.icon size="mini" class="w-4 h-4" %}
                <span>{{ cat_info.name }}</span>
            </a>
            {% endfor %}
        </nav>
    </div>
    
    <!-- Controls Bar -->
    {% if current_category != 'contributors' %}
    <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 mb-8">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
            <!-- Category Description -->
            <div class="flex-1">
                <div class="flex items-center gap-3 mb-2">
                    {% heroicon current_category_info.icon size="mini" class="w-5 h-5 text-gray-400" %}
                    <h2 class="text-lg font-semibold text-gray-900">{{ current_category_info.name }}</h2>
                </div>
                <p class="text-gray-600">{{ current_category_info.description }}</p>
                {% if leaderboard_data %}
                <p class="text-sm text-gray-500 mt-1">
                    Showing {{ leaderboard_data.entries|length }} of {{ leaderboard_data.total_count }} councils
                    {% if leaderboard_data.year %} • {{ leaderboard_data.year }}{% endif %}
                </p>
                {% endif %}
            </div>
            
            <!-- Controls -->
            <div class="flex flex-wrap items-center gap-6">
                <!-- Per Capita Toggle -->
                <div class="flex items-center gap-3">
                    <label for="per-capita-toggle" class="text-sm font-medium text-gray-700">Per Capita</label>
                    <div class="relative">
                        <input type="checkbox" 
                               id="per-capita-toggle" 
                               class="sr-only" 
                               {% if per_capita %}checked{% endif %}
                               onchange="togglePerCapita()">
                        <div class="toggle-switch w-11 h-6 bg-gray-200 rounded-full cursor-pointer transition-colors duration-300 {% if per_capita %}bg-green-500{% endif %}">
                            <div class="toggle-knob w-4 h-4 bg-white rounded-full shadow transform transition-transform duration-300 {% if per_capita %}translate-x-6{% else %}translate-x-1{% endif %} mt-1"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Year Selector -->
                <div class="flex items-center gap-2">
                    <label for="year-select" class="text-sm font-medium text-gray-700">Year:</label>
                    <select id="year-select" 
                            onchange="changeYear(this.value)"
                            class="block w-auto px-3 py-2 text-sm border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        {% for year in available_years %}
                        <option value="{{ year.label }}" {% if year.label == year_label %}selected{% endif %}>
                            {{ year.label }}{% if year.is_forecast %} (Forecast){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Main Content -->
    {% if leaderboard_data and leaderboard_data.entries %}
        <div class="space-y-3">
            {% if show_contributors %}
                <!-- Contributors Leaderboard -->
                {% for entry in leaderboard_data.entries %}
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow duration-200">
                    <div class="flex items-center">
                        <!-- Rank Badge -->
                        <div class="flex-shrink-0 mr-4">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold
                                        {% if entry.rank == 1 %}bg-yellow-400 text-yellow-900
                                        {% elif entry.rank == 2 %}bg-gray-300 text-gray-800
                                        {% elif entry.rank == 3 %}bg-orange-400 text-orange-900
                                        {% else %}bg-gray-100 text-gray-700{% endif %}">
                                {{ entry.rank }}
                            </div>
                        </div>
                        
                        <!-- User Info -->
                        <div class="flex-1 min-w-0">
                            <h3 class="font-semibold text-gray-900 truncate">{{ entry.username }}</h3>
                            <div class="flex items-center gap-4 mt-1">
                                <span class="text-sm text-gray-600 flex items-center gap-1">
                                    {% heroicon "star" size="mini" class="w-4 h-4 text-yellow-500" %}
                                    {{ entry.points|intcomma }} points
                                </span>
                                {% if entry.badge %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    {{ entry.badge }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Arrow -->
                        <div class="flex-shrink-0 ml-4">
                            {% heroicon "chevron-right" size="mini" class="w-5 h-5 text-gray-400" %}
                        </div>
                    </div>
                </div>
                {% endfor %}
                
            {% else %}
                <!-- Council Financial Rankings -->
                {% for entry in leaderboard_data.entries %}
                <a href="{% url 'council_detail' entry.council_slug %}" class="block">
                    <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md hover:border-gray-300 transition-all duration-200">
                        <div class="flex items-center">
                            <!-- Rank Badge -->
                            <div class="flex-shrink-0 mr-4">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold
                                            {% if entry.rank == 1 %}bg-yellow-400 text-yellow-900
                                            {% elif entry.rank == 2 %}bg-gray-300 text-gray-800
                                            {% elif entry.rank == 3 %}bg-orange-400 text-orange-900
                                            {% else %}bg-gray-100 text-gray-700{% endif %}">
                                    {{ entry.rank }}
                                </div>
                            </div>
                            
                            <!-- Council Info -->
                            <div class="flex-1 min-w-0">
                                <h3 class="font-semibold text-gray-900 truncate">{{ entry.council_name }}</h3>
                                <div class="flex flex-wrap items-center gap-x-4 gap-y-1 mt-1">
                                    {% if entry.council_type %}
                                    <span class="text-sm text-gray-600 flex items-center gap-1">
                                        {% heroicon "building-office" size="mini" class="w-3 h-3" %}
                                        {{ entry.council_type }}
                                    </span>
                                    {% endif %}
                                    {% if entry.council_nation %}
                                    <span class="text-sm text-gray-500 flex items-center gap-1">
                                        {% heroicon "flag" size="mini" class="w-3 h-3" %}
                                        {{ entry.council_nation }}
                                    </span>
                                    {% endif %}
                                    {% if per_capita and entry.population %}
                                    <span class="text-sm text-gray-500 flex items-center gap-1">
                                        {% heroicon "users" size="mini" class="w-3 h-3" %}
                                        {{ entry.population|floatformat:0|intcomma }} residents
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Value -->
                            <div class="flex-shrink-0 text-right mx-4">
                                <div class="font-bold text-gray-900">
                                    {% if per_capita %}
                                        £{{ entry.display_value|floatformat:2|intcomma }}
                                        <span class="text-xs font-normal text-gray-600 block">per capita</span>
                                    {% else %}
                                        £{{ entry.display_value|floatformat:0|intcomma }}
                                    {% endif %}
                                </div>
                                {% if per_capita and entry.value != entry.display_value %}
                                <div class="text-sm text-gray-500 mt-1">
                                    Total: £{{ entry.value|floatformat:0|intcomma }}
                                </div>
                                {% endif %}
                                {% if entry.percentile %}
                                <div class="text-xs text-gray-400 mt-1">
                                    {{ entry.percentile|floatformat:0 }}th percentile
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Arrow -->
                            <div class="flex-shrink-0">
                                {% heroicon "chevron-right" size="mini" class="w-5 h-5 text-gray-400" %}
                            </div>
                        </div>
                    </div>
                </a>
                {% endfor %}
            {% endif %}
        </div>
    {% else %}
        <!-- Empty State -->
        <div class="text-center py-16">
            <div class="mx-auto w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                {% heroicon "chart-bar" size="outline" class="w-8 h-8 text-gray-400" %}
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No data available</h3>
            <p class="text-gray-600 mb-4">
                {% if current_category == 'contributors' %}
                    No contributors found.
                {% else %}
                    No data available for {{ current_category_info.name }}.
                {% endif %}
            </p>
            {% if year_label and current_category != 'contributors' %}
            <p class="text-sm text-gray-500">Try selecting a different year or category.</p>
            {% endif %}
        </div>
    {% endif %}
</div>

<style>
/* Custom toggle switch styles */
.toggle-switch {
    cursor: pointer;
}

.toggle-switch input:checked + .toggle-knob {
    transform: translateX(1.5rem);
}

/* Scrollbar hide utility */
.scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
}

.scrollbar-hide::-webkit-scrollbar {
    display: none;
}

/* Mobile optimizations */
@media (max-width: 640px) {
    .toggle-switch {
        width: 2.5rem;
        height: 1.25rem;
    }
    
    .toggle-knob {
        width: 0.875rem;
        height: 0.875rem;
        margin-top: 0.1875rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
    function togglePerCapita() {
        const urlParams = new URLSearchParams(window.location.search);
        const currentPerCapita = urlParams.get('per_capita') === 'true';
        
        if (currentPerCapita) {
            urlParams.delete('per_capita');
        } else {
            urlParams.set('per_capita', 'true');
        }
        
        addLoadingState();
        window.location.search = urlParams.toString();
    }
    
    function changeYear(year) {
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('year', year);
        
        addLoadingState();
        window.location.search = urlParams.toString();
    }
    
    function addLoadingState() {
        const overlay = document.createElement('div');
        overlay.className = 'fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50';
        overlay.innerHTML = `
            <div class="flex items-center space-x-3">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <span class="text-gray-700 font-medium">Loading...</span>
            </div>
        `;
        document.body.appendChild(overlay);
    }
    
    // Category navigation with loading states
    document.addEventListener('DOMContentLoaded', function() {
        const categoryLinks = document.querySelectorAll('nav a[href*="category="]');
        categoryLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                if (!this.getAttribute('aria-current')) {
                    addLoadingState();
                }
            });
        });
        
        // Smooth scroll to top on page load
        if (window.location.search.includes('category=')) {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    });
</script>
{% endblock %}