{% extends "base.html" %}
{% load static %}
{% block title %}Home - Council Finance Counters{% endblock %}
{% block content %}
<div id="homepage-search" class="text-center my-8">
    <form method="get" action="{% url 'home' %}" class="my-4 flex gap-2">
        <!-- Allow the search field to expand and occupy the remaining space so
             it stretches across the page on larger screens. -->
        <input type="text" name="q" value="{{ query }}" placeholder="Search councils" class="border rounded px-2 py-1 flex-grow w-full" />
        <button type="submit" class="bg-blue-600 text-white px-4 py-1 rounded">Search</button>
    </form>
</div>
<h1 class="text-2xl font-bold mb-4 text-center">
    Welcome to our UK-wide open data project for council finances
</h1>
<h2 class="text-center">
     <span class="text-sm text-gray-500">Tracking data for {{ total_councils|floatformat:0 }} councils</span>
</h2>
<div id="homepage-counters" class="my-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
    {% if promoted_counters %}
        {% for item in promoted_counters %}
            <div id="counter-{{ item.slug }}" class="bg-gray-100 shadow rounded p-10 text-center space-y-2 relative resize-counter sm:col-span-{{ item.columns }}" data-slug="{{ item.slug }}" data-default-span="{{ item.columns }}">
                <p class="text-sm text-gray-500 flex items-center justify-center gap-1">
                    {{ item.name }}
                    {% if item.explanation %}
                        <button type="button" onclick="toggleInfo('info-{{ forloop.counter0 }}')" class="text-blue-600" aria-label="More info">
                            <i class="fas fa-info-circle"></i>
                        </button>
                        {% endif %}
                    </p>
                    <p class="text-4xl sm:text-4xl font-bold counter-value"
                        data-value="{{ item.raw }}"
                        data-duration="{{ item.duration }}"
                        data-precision="{{ item.precision }}"
                        data-show-currency="{{ item.show_currency }}"
                        data-friendly="{{ item.friendly_format }}"
                        data-formatted="{{ item.formatted }}">0</p>
                    <p class="counter-factoid text-sm text-gray-600"></p>
                    {% if item.explanation %}
                    <p id="info-{{ forloop.counter0 }}" class="hidden text-sm text-gray-700">{{ item.explanation }}</p>
                    {% endif %}
                <div class="absolute bottom-0 right-0 w-3 h-3 bg-gray-300 cursor-ew-resize handle"></div>
                {% with script_id='factoids-'|add:item.slug %}
                {{ item.factoids|json_script:script_id }}
                {% endwith %}
            </div>
        {% endfor %}
        <!-- Hidden element ensures Tailwind's JIT engine generates utility
             classes for all column spans used by the resize script. -->
        <div class="hidden sm:col-span-1 sm:col-span-2 sm:col-span-3"></div>
    {% endif %}
</div>
<ul class="list-disc pl-5">
{% for council in councils %}
    <li><a href="{% url 'council_detail' council.slug %}" class="text-blue-700 hover:underline">{{ council.name }}</a></li>
{% empty %}
    {% if query %}
    <li>No councils found.</li>
    {% endif %}
{% endfor %}
</ul>
{% endblock %}
{% block extra_scripts %}
<script src="{% static 'js/countUp.umd.js' %}"></script>
<style>
  .counter-factoid{max-height:0;overflow:hidden;transition:max-height 0.5s ease;}
  .counter-factoid.show{max-height:3rem;}
</style>
<script>
function toggleInfo(id) {
    const el = document.getElementById(id);
    if (el) el.classList.toggle('hidden');
}
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.counter-value').forEach(el => {
        const val = parseFloat(el.dataset.value || '0');
        const dur = parseInt(el.dataset.duration || '0') / 1000;
        const showCurrency = el.dataset.showCurrency === 'true';
        const precision = parseInt(el.dataset.precision || '0');
        const thousands = showCurrency;
        const display = el.dataset.formatted || val.toLocaleString();
        const cu = new countUp.CountUp(el, val, {
            duration: dur,
            decimalPlaces: precision,
            separator: thousands ? ',' : '',
            prefix: showCurrency ? 'Â£' : '',
            easingFn: (t, b, c, d) => {
                t /= d; return -c * t * (t - 2) + b; // easeOutQuad
            }
        });
        el.textContent = cu.formattingFn(0);
        const container = el.parentElement;
        const factEl = container.querySelector('.counter-factoid');
        let facts = [];
        const script = document.getElementById('factoids-' + container.dataset.slug);
        if (script) {
            try { facts = JSON.parse(script.textContent); } catch (e) { facts = []; }
        }
        function cycleFacts(i=0){
            if(!factEl || !facts.length) return;
            const f = facts[i];
            factEl.innerHTML = f.icon ? `<i class='fas ${f.icon}'></i> ${f.text}` : f.text;
            factEl.classList.add('show');
            setTimeout(() => {
                factEl.classList.remove('show');
                setTimeout(() => cycleFacts((i+1)%facts.length), 500);
            }, 4000);
        }
        if (!cu.error) {
            cu.start(() => { el.textContent = display; cycleFacts(); });
        } else {
            el.textContent = display;
            cycleFacts();
        }
    });
    // Allow visitors to resize promoted counters and persist using localStorage
    const spans = JSON.parse(localStorage.getItem('counterSpans') || '{}');
    document.querySelectorAll('.resize-counter').forEach(box => {
        const slug = box.dataset.slug;
        const def = parseInt(box.dataset.defaultSpan || '1');
        const saved = parseInt(spans[slug] || def);
        setSpan(box, saved);
        const handle = box.querySelector('.handle');
        if (!handle) return;
        let startX;
        function move(e){
            const diff = e.clientX - startX;
            const w = box.parentElement.clientWidth / 3;
            const newSpan = diff + box.offsetWidth < w * 1.5 ? 1 : (diff + box.offsetWidth < w * 2.5 ? 2 : 3);
            setSpan(box, newSpan);
        }
        function up(){
            document.removeEventListener('mousemove', move);
            document.removeEventListener('mouseup', up);
            spans[slug] = box.dataset.span;
            localStorage.setItem('counterSpans', JSON.stringify(spans));
        }
        handle.addEventListener('mousedown', e => {
            startX = e.clientX;
            document.addEventListener('mousemove', move);
            document.addEventListener('mouseup', up);
        });
    });

    function setSpan(el, span){
        el.dataset.span = span;
        el.classList.remove('sm:col-span-1','sm:col-span-2','sm:col-span-3');
        el.classList.add(`sm:col-span-${span}`);
    }
});
</script>
{% endblock %}
