{% extends "base.html" %}
{% block title %}Contribute - Council Finance Counters{% endblock %}
{% block content %}
<h1 class="text-2xl font-bold mb-4">Contribute Data</h1>
<div class="space-y-6">
    <section>
        <h2 class="text-xl font-semibold mb-2">Contribution Queue</h2>
        {% if queue %}
        <table class="min-w-full border divide-y divide-gray-200">
            <thead class="bg-gray-100">
                <tr>
                    <th class="px-3 py-2 text-left">ID</th>
                    <th class="px-2 py-1 text-left">Council</th>
                    <th class="px-2 py-1 text-left">Field</th>
                    <th class="px-2 py-1 text-left">Change</th>
                    <th class="px-2 py-1 text-left">Submitted By</th>
                    <th class="px-2 py-1 text-left">Date</th>
                    {% if user.is_authenticated and user.profile.tier.level >= 3 %}
                    <th class="px-2 py-1 text-left">Actions</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
            {% for c in queue %}
                <tr class="border-b">
                    <td class="px-3 py-2 text-sm">{{ c.id }}</td>
                    <td class="px-2 py-1 flex items-center">
                        <span class="w-5 h-5 rounded-full bg-gray-300 mr-2"></span>
                        <a href="{% url 'council_detail' c.council.slug %}" class="text-blue-700 hover:underline">{{ c.council.name }}</a>
                    </td>
                    <td class="px-2 py-1">{{ c.field.name }}</td>
                    <td class="px-2 py-1">{{ c.display_old_value }} <span class="mx-1">&rarr;</span> {{ c.display_new_value }}</td>
                    <td class="px-2 py-1">{{ c.user.username }}</td>
                    <td class="px-2 py-1">{{ c.created|date:"Y-m-d H:i" }}</td>
                    {% if user.is_authenticated and user.profile.tier.level >= 3 %}
                    <td class="px-2 py-1 space-x-2">
                        <form method="post" action="{% url 'review_contribution' c.id 'approve' %}" class="inline">
                            {% csrf_token %}
                            <button class="text-green-600" aria-label="Approve"><i class="fas fa-check"></i></button>
                        </form>
                        <button class="edit-btn text-blue-600" data-url="{% url 'review_contribution' c.id 'edit' %}" data-value="{{ c.value }}" aria-label="Edit"><i class="fas fa-edit"></i></button>
                        <button class="reject-btn text-red-600" data-url="{% url 'review_contribution' c.id 'reject' %}" aria-label="Reject"><i class="fas fa-times"></i></button>
                    </td>
                    {% endif %}
                </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>No pending contributions.</p>
        {% endif %}
    </section>
    <section>
        <h2 class="text-xl font-semibold mb-2">My Contributions</h2>
        {% if user.is_authenticated %}
            {% if my_contribs %}
            <table class="min-w-full border divide-y divide-gray-200">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-3 py-2 text-left">ID</th>
                        <th class="px-2 py-1 text-left">Council</th>
                        <th class="px-2 py-1 text-left">Field</th>
                        <th class="px-2 py-1 text-left">Change</th>
                        <th class="px-2 py-1 text-left">Status</th>
                        <th class="px-2 py-1 text-left">Date</th>
                    </tr>
                </thead>
                <tbody>
                {% for c in my_contribs %}
                    <tr class="border-b">
                        <td class="px-3 py-2 text-sm">{{ c.id }}</td>
                        <td class="px-2 py-1 flex items-center">
                            <span class="w-5 h-5 rounded-full bg-gray-300 mr-2"></span>
                            <a href="{% url 'council_detail' c.council.slug %}" class="text-blue-700 hover:underline">{{ c.council.name }}</a>
                        </td>
                        <td class="px-2 py-1">{{ c.field.name }}</td>
                        <td class="px-2 py-1">{{ c.display_old_value }} <span class="mx-1">&rarr;</span> {{ c.display_new_value }}</td>
                        <td class="px-2 py-1">{{ c.status }}</td>
                        <td class="px-2 py-1">{{ c.created|date:"Y-m-d H:i" }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>You haven't submitted any contributions yet.</p>
            {% endif %}
        {% else %}
            <p><a href="{% url 'login' %}" class="underline">Log in</a> to see your contributions.</p>
        {% endif %}
    </section>
    <section>
        <h2 class="text-xl font-semibold">Contributions by Friends</h2>
        <p>Placeholder list showing what your friends submitted.</p>
    </section>
    <section>
        <h2 class="text-xl font-semibold">Contributions for Councils I am Following</h2>
        <p>Placeholder for followed councils.</p>
    </section>
    <section>
        <h2 class="text-xl font-semibold">Top Rate Contributions</h2>
        <p>Placeholder for the best rated submissions.</p>
    </section>
</div>

<!-- Modal used for editing a contribution -->
<div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <form method="post" id="edit-form" class="bg-white p-4 rounded shadow">
    {% csrf_token %}
    <label class="block mb-2">New value
      <input type="text" name="value" id="edit-value" class="border p-2 w-full" />
    </label>
    <div class="text-right space-x-2">
      <button type="submit" class="bg-blue-600 text-white px-4 py-1 rounded">Save</button>
      <button type="button" id="edit-cancel" class="px-4 py-1 border rounded">Cancel</button>
    </div>
  </form>
</div>

<!-- Modal used when rejecting a contribution -->
<div id="reject-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <form method="post" id="reject-form" class="bg-white p-4 rounded shadow">
    {% csrf_token %}
    <label class="block mb-2">Reason
      <select name="reason" id="reject-reason" class="border p-2 w-full">
        <option value="data_incorrect">The data wasn't correct</option>
        <option value="no_sources">We can't find reliable sources</option>
        <option value="other">Other (specify)</option>
      </select>
    </label>
    <input type="text" name="details" id="reject-details" class="border p-2 w-full mb-2 hidden" placeholder="Details" />
    <div class="text-right space-x-2">
      <button type="submit" class="bg-red-600 text-white px-4 py-1 rounded">Reject</button>
      <button type="button" id="reject-cancel" class="px-4 py-1 border rounded">Cancel</button>
    </div>
  </form>
</div>

<script>
document.querySelectorAll('.edit-btn').forEach(btn => {
  btn.addEventListener('click', e => {
    e.preventDefault();
    document.getElementById('edit-form').action = btn.dataset.url;
    document.getElementById('edit-value').value = btn.dataset.value;
    document.getElementById('edit-modal').classList.remove('hidden');
  });
});
document.getElementById('edit-cancel').addEventListener('click', () => {
  document.getElementById('edit-modal').classList.add('hidden');
});

document.querySelectorAll('.reject-btn').forEach(btn => {
  btn.addEventListener('click', e => {
    e.preventDefault();
    document.getElementById('reject-form').action = btn.dataset.url;
    document.getElementById('reject-modal').classList.remove('hidden');
  });
});
document.getElementById('reject-cancel').addEventListener('click', () => {
  document.getElementById('reject-modal').classList.add('hidden');
});
document.getElementById('reject-reason').addEventListener('change', function() {
  document.getElementById('reject-details').classList.toggle('hidden', this.value !== 'other');
});
</script>
{% endblock %}
