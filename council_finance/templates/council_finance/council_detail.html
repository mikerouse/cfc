{% extends "base.html" %}
{% load static %}
{% block title %}{{ council.name }} - Council Finance Counters{% endblock %}
{% block content %}
<h1 class="text-3xl sm:text-4xl font-extrabold mb-4 text-center">{{ council.name }}</h1>
<p>Slug: {{ council.slug }}</p>
{% if council.website %}
<p>Website: <a href="{{ council.website }}" class="text-blue-700 hover:underline">{{ council.website }}</a></p>
{% endif %}
{% if council.council_type %}
<p>Type: {{ council.council_type.name }}</p>
{% endif %}
<div class="mt-2 flex flex-col sm:flex-row items-center gap-4">
  <div>
    <label for="year-select" class="sr-only">Financial year</label>
    <select id="year-select" class="border rounded px-2 py-1 bg-gray-100">
      {% for y in years %}
        <option value="{{ y.label }}" {% if y.label == selected_year.label %}selected{% endif %}>{{ y.display }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="flex items-center gap-2">
    <label for="column-slider" class="text-sm">Columns</label>
    <input id="column-slider" type="range" min="1" max="3" step="1" class="w-40">
  </div>
  <button id="drawer-toggle" class="bg-blue-600 text-white px-3 py-1 rounded">Choose counters</button>
</div>
<div id="counter-drawer" class="overflow-hidden max-h-0 transition-all">
  <form class="p-2 space-y-2 bg-gray-50 rounded" onsubmit="return false;">
    {% for item in counters %}
    <label class="block"><input type="checkbox" data-slug="{{ item.counter.slug }}" class="mr-2">{{ item.counter.name }}</label>
    {% endfor %}
    <button id="drawer-apply" class="mt-2 bg-blue-600 text-white px-2 py-1 rounded">Apply</button>
  </form>
</div>
{% if counters %}
<div id="counters-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 my-6">
    {% for item in counters %}
    <div class="bg-green-50 p-4 rounded shadow text-center" data-counter="{{ item.counter.slug }}">
        <p class="text-sm text-gray-600">{{ item.counter.name }}</p>
        <p class="text-red-700 text-sm counter-error" {% if not item.error %}style="display:none"{% endif %}>{{ item.error }}</p>
        <p class="text-2xl font-bold counter-value" data-duration="{{ item.counter.duration }}" data-value="{{ item.value }}" data-formatted="{{ item.formatted }}" {% if item.error %}style="display:none"{% endif %}>0</p>
        <p class="text-xs mt-1">{{ item.counter.explanation }}</p>
    </div>
    {% endfor %}
</div>
{{ default_counter_slugs|json_script:"default-slugs" }}
{#
  Load the CountUp library from our static files so the page
  works even when external CDNs are unreachable.
#}
<script src="{% static 'js/countUp.umd.js' %}"></script>
<script>
function animateCounters() {
  document.querySelectorAll('.counter-value').forEach(el => {
    if (!el.dataset.value) return;
    const end = parseFloat(el.dataset.value || '0');
    const dur = parseInt(el.dataset.duration || '0') / 1000;
    const display = el.dataset.formatted || end.toLocaleString();
    // Create an animator instance from the CountUp library. The global
    // object exposes the constructor as `countUp.CountUp` when using the
    // UMD build we load above.
    const cu = new countUp.CountUp(el, end, {duration: dur});
    if (!cu.error) {
      cu.start(() => { el.textContent = display; });
    } else {
      el.textContent = display;
    }
  });
}

async function loadCounters(year) {
  const url = `{% url 'council_counters' council.slug %}?year=${encodeURIComponent(year)}`;
  try {
    const resp = await fetch(url, {headers: {'X-Requested-With': 'XMLHttpRequest'}});
    const data = await resp.json();
    Object.entries(data.counters).forEach(([slug, info]) => {
      const container = document.querySelector(`[data-counter="${slug}"]`);
      if (!container) return;
      const valEl = container.querySelector('.counter-value');
      const errEl = container.querySelector('.counter-error');
      if (info.error) {
        if (errEl) { errEl.textContent = info.error; errEl.style.display = ''; }
        if (valEl) { valEl.style.display = 'none'; }
      } else {
        if (errEl) { errEl.textContent = ''; errEl.style.display = 'none'; }
        if (valEl) {
          valEl.dataset.value = info.value;
          valEl.dataset.formatted = info.formatted;
          valEl.dataset.duration = info.duration;
          valEl.style.display = '';
        }
      }
    });
    animateCounters();
  } catch (e) {
    console.error('Failed to load counters', e);
  }
}

document.getElementById('year-select').addEventListener('change', e => {
  loadCounters(e.target.value);
});

const councilSlug = '{{ council.slug }}';
const grid = document.getElementById('counters-grid');
const slider = document.getElementById('column-slider');
const drawer = document.getElementById('counter-drawer');
const toggleBtn = document.getElementById('drawer-toggle');
const applyBtn = document.getElementById('drawer-apply');

function defaultCols() {
  if (window.innerWidth < 640) return 1;
  if (window.innerWidth < 768) return 2;
  return 3;
}

function setCols(n) {
  grid.style.gridTemplateColumns = `repeat(${n}, minmax(0,1fr))`;
}

const storedCols = localStorage.getItem(`cols_${councilSlug}`);
const cols = storedCols ? parseInt(storedCols, 10) : defaultCols();
slider.value = cols;
setCols(cols);

slider.addEventListener('input', e => {
  const val = parseInt(e.target.value, 10);
  setCols(val);
  localStorage.setItem(`cols_${councilSlug}`, val);
});

const defaultSlugs = JSON.parse(document.getElementById('default-slugs').textContent);

function applyPrefs(slugs) {
  document.querySelectorAll('#counter-drawer input[type=checkbox]').forEach(cb => {
    cb.checked = slugs.includes(cb.dataset.slug);
  });
  document.querySelectorAll('#counters-grid [data-counter]').forEach(div => {
    div.style.display = slugs.includes(div.dataset.counter) ? '' : 'none';
  });
}

let savedSlugs;
try {
  savedSlugs = JSON.parse(localStorage.getItem(`counters_${councilSlug}`));
} catch (err) { savedSlugs = null; }
applyPrefs(savedSlugs || defaultSlugs);

applyBtn.addEventListener('click', () => {
  const selected = Array.from(document.querySelectorAll('#counter-drawer input[type=checkbox]:checked')).map(cb => cb.dataset.slug);
  localStorage.setItem(`counters_${councilSlug}`, JSON.stringify(selected));
  applyPrefs(selected);
  drawer.style.maxHeight = null;
});

toggleBtn.addEventListener('click', () => {
  if (drawer.style.maxHeight) {
    drawer.style.maxHeight = null;
  } else {
    drawer.style.maxHeight = drawer.scrollHeight + 'px';
  }
});

animateCounters();
</script>
{% endif %}
{% if figures %}
<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 my-6">
    {% for fig in figures %}
    <div class="bg-blue-50 p-4 rounded shadow text-center">
        <p class="text-sm text-gray-600">{{ fig.year.label }} - {{ fig.field.name|capfirst }}</p>
        <p class="text-2xl font-bold">{{ fig.value }}</p>
    </div>
    {% endfor %}
</div>
{% endif %}
<p class="mt-4"><a href="{% url 'council_list' %}" class="text-blue-700 hover:underline">Back to all councils</a></p>
{% endblock %}

