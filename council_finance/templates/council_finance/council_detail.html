{% extends "council_finance/base.html" %}
{% load static %}
{% load logo_tags %}
{% load humanize %}
{% block title %}{{ council.name }} - Council Finance Counters{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/favourites.js' %}"></script>
<script src="{% static 'js/ai-factoids.js' %}"></script>
<!-- Flagging system is loaded globally in base.html -->
{% endblock %}

{% block content %}
<div class="mx-auto max-w-none xl:max-w-desktop">
  <!-- Council Header -->
  <div class="bg-white shadow-sm border-b border-gray-200 -mx-3 sm:-mx-4 xl:-mx-6 mb-8">
    <div class="max-w-none xl:max-w-desktop mx-auto px-6 sm:px-8 xl:px-12">
      
      <!-- Main Header Content -->
      <div class="py-6 sm:py-8">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
          
          <!-- Council Info -->
          <div class="flex items-start gap-4 min-w-0 flex-1">
            <!-- Council Logo -->
            <div class="w-16 h-16 sm:w-20 sm:h-20 rounded-lg bg-gray-100 flex items-center justify-center flex-shrink-0 border border-gray-200">
              {% council_logo_img council size=80 css_classes="w-full h-full object-cover rounded-lg" %}
            </div>
            
            <!-- Council Details -->
            <div class="min-w-0 flex-1">
              <div id="council-detail-name" class="mb-2">
                <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900 leading-tight">{{ council.name }}</h1>
              </div>
              
              <!-- Council Type Badge -->
              {% if council.council_type %}
                <div class="mb-3">
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                    {{ council.council_type }}
                  </span>
                </div>
              {% endif %}
              
              <!-- Council Meta Info -->
              <div class="flex flex-wrap items-center gap-x-4 gap-y-2 text-sm text-gray-600">
                {% for meta_field in meta_fields %}
                  {% if meta_field.value %}
                    <div class="flex items-center gap-2">
                      {% if meta_field.field.icon_svg_path %}
                        <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="{{ meta_field.field.icon_svg_path }}"/>
                        </svg>
                      {% endif %}
                      <span>
                        {% if meta_field.field.slug == 'council-website' %}
                          <a href="{{ meta_field.value }}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline">
                            {{ meta_field.value|truncatechars:30 }}
                          </a>
                        {% else %}
                          {{ meta_field.formatted_value }}
                        {% endif %}
                      </span>
                    </div>
                  {% endif %}
                {% endfor %}
                
                <!-- Population Fallback -->
                {% if council.latest_population and not population_in_meta %}
                  <div class="flex items-center gap-2">
                    <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 515.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                    <span>{{ council.latest_population|floatformat:0|intcomma }} residents</span>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
          
          <!-- Action Buttons - Always visible, with auth prompts for logged-out users -->
          <div class="flex flex-col sm:flex-row gap-3 lg:flex-shrink-0">
            <!-- Add to Favourites Button -->
            <button id="favourite-btn" 
                    class="gov-uk-button {% if user.is_authenticated and is_favourited %}gov-uk-button--warning{% else %}gov-uk-button--secondary{% endif %}"
                    data-slug="{{ council.slug }}"
                    data-favourited="{{ is_favourited|yesno:'true,false' }}"
                    data-requires-auth="true">
              <svg class="w-4 h-4 mr-2 flex-shrink-0" {% if user.is_authenticated and is_favourited %}fill="currentColor"{% else %}fill="none"{% endif %} stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
              </svg>
              <span>{% if user.is_authenticated and is_favourited %}Remove from Favourites{% else %}Add to Favourites{% endif %}</span>
            </button>
            
            <!-- Follow Button -->
            <button id="follow-btn" 
                    class="gov-uk-button {% if user.is_authenticated and is_following %}gov-uk-button--warning{% endif %}"
                    data-following="{{ is_following|yesno:'true,false' }}" 
                    data-slug="{{ council.slug }}"
                    data-requires-auth="true">
              <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                {% if user.is_authenticated and is_following %}
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/>
                {% else %}
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                {% endif %}
              </svg>
              <span>{% if user.is_authenticated and is_following %}Unfollow{% else %}Follow{% endif %}</span>
            </button>
            
            <!-- Compare Button -->
            <button id="compare-btn" 
                    class="gov-uk-button gov-uk-button--secondary"
                    data-slug="{{ council.slug }}"
                    data-requires-auth="true">
              <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
              </svg>
              <span>Compare</span>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Navigation Tabs - GOV.UK Style -->
      <div class="border-t border-gray-200">
        <nav class="flex space-x-0 overflow-x-auto" role="tablist">
          <a href="{% url 'council_detail' council.slug %}" 
             class="gov-uk-tab gov-uk-tab--active"
             role="tab"
             aria-selected="true">
            <span class="flex items-center gap-2 whitespace-nowrap">
              <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
              </svg>
              <span>Finances</span>
            </span>
          </a>
          
          <a href="{% url 'council_edit' council.slug %}" 
             class="gov-uk-tab"
             role="tab"
             aria-selected="false">
            <span class="flex items-center gap-2 whitespace-nowrap">
              <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
              </svg>
              <span>Edit</span>
            </span>
          </a>
          
          <a href="{% url 'council_change_log' council.slug %}" 
             class="gov-uk-tab {% if tab == 'log' %}gov-uk-tab--active{% endif %}"
             role="tab"
             aria-selected="{% if tab == 'log' %}true{% else %}false{% endif %}">
            <span class="flex items-center gap-2 whitespace-nowrap">
              <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              <span>Activity Log</span>
            </span>
          </a>
        </nav>
      </div>
    </div>
  </div>

  <!-- Leaderboard Context Banner -->
  {% if leaderboard_context %}
    <div class="mb-6">
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex items-start">
          <div class="flex-shrink-0 mr-3">
            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
          </div>
          <div class="flex-1">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-sm font-medium text-blue-800 mb-1">
                  Leaderboard Position
                </h3>
                <p class="text-sm text-blue-700">
                  {% if leaderboard_context.rank %}
                    Ranked #{{ leaderboard_context.rank }} in 
                    {% if leaderboard_context.category == 'contributors' %}Top Contributors{% elif leaderboard_context.category == 'total-debt' %}Total Debt{% elif leaderboard_context.category == 'interest-payments' %}Interest Payments{% elif leaderboard_context.category == 'current-liabilities' %}Current Liabilities{% elif leaderboard_context.category == 'long-term-liabilities' %}Long-term Liabilities{% elif leaderboard_context.category == 'reserves-balances' %}Reserves & Balances{% elif leaderboard_context.category == 'council-tax-income' %}Council Tax Income{% elif leaderboard_context.category == 'lowest-debt' %}Lowest Debt{% elif leaderboard_context.category == 'lowest-interest' %}Lowest Interest Payments{% else %}{{ leaderboard_context.category|title }}{% endif %}{% if leaderboard_context.per_capita %} (per capita){% endif %}{% if leaderboard_context.year %} - {{ leaderboard_context.year }}{% endif %}
                  {% else %}
                    From {{ leaderboard_context.category|title }} leaderboard
                  {% endif %}
                </p>
              </div>
              <a href="{% url 'leaderboards' %}?category={{ leaderboard_context.category }}{% if leaderboard_context.year %}&year={{ leaderboard_context.year }}{% endif %}{% if leaderboard_context.per_capita %}&per_capita=true{% endif %}" 
                 class="inline-flex items-center px-3 py-1.5 border border-blue-300 text-xs font-medium rounded-md text-blue-700 bg-white hover:bg-blue-50 transition-colors">
                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Back to Leaderboard
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  <!-- Administrative Messages -->
  {% if administrative_messages %}
    <div class="space-y-4 mb-6">
      {% for message in administrative_messages %}
        <div class="rounded-lg border-l-4 p-4 
          {% if message.type == 'merge' %}bg-blue-50 border-blue-400 text-blue-800
          {% elif message.type == 'flag' %}bg-yellow-50 border-yellow-400 text-yellow-800
          {% elif message.type == 'defunct' %}bg-red-50 border-red-400 text-red-800
          {% else %}bg-gray-50 border-gray-400 text-gray-800{% endif %}">
          <div class="flex items-start">
            <div class="flex-shrink-0 mr-3">
              {% if message.type == 'merge' %}
                <svg class="w-5 h-5 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                </svg>
              {% elif message.type == 'flag' %}
                <svg class="w-5 h-5 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                </svg>
              {% elif message.type == 'defunct' %}
                <svg class="w-5 h-5 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
              {% endif %}
            </div>
            <div class="flex-1">
              <p class="text-sm font-medium">{{ message.message }}</p>
              {% if message.timestamp %}
                <p class="text-xs opacity-75 mt-1">{{ message.timestamp|date:"F j, Y \a\t g:i A" }}</p>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- AI Financial Insights - GOV.UK Notice Style -->
  <div class="mb-8">
    <div class="ai-factoid-playlist gov-uk-notification-banner" 
         data-council="{{ council.slug }}"
         role="region" 
         aria-label="AI Financial Insights">
      <!-- Loading state -->
      <div class="gov-uk-notification-banner__header">
        <h2 class="gov-uk-notification-banner__title" id="ai-insights-title">
          <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
          </svg>
          AI Financial Insights
        </h2>
      </div>
      <div class="gov-uk-notification-banner__content">
        <div class="flex items-center space-x-3">
          <div class="animate-spin">
            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
          </div>
          <p class="gov-uk-body-s">Analyzing financial data to generate insights...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Financial Data View - Full Width Layout -->
  <div class="space-y-6">
        <!-- Controls Section -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
          <!-- Mobile Accordion Header -->
          <div class="md:hidden">
            <button id="mobile-financial-toggle" 
                    class="w-full px-4 py-4 text-left focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-t-lg"
                    aria-expanded="false"
                    aria-controls="financial-overview-content">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="text-lg font-semibold text-gray-900">Financial Overview</h3>
                  <p class="text-sm text-gray-600 mt-1">Tap to view controls</p>
                </div>
                <div class="flex-shrink-0">
                  <svg id="mobile-toggle-icon" class="w-5 h-5 text-gray-500 transition-transform transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
                </div>
              </div>
            </button>
          </div>
          
          <!-- Desktop Header -->
          <div class="hidden md:block px-4 py-4 sm:px-6 border-b border-gray-200">
            <div class="space-y-4 sm:space-y-0 sm:flex sm:items-center sm:justify-between">
              <div>
                <h3 class="text-lg font-semibold text-gray-900">Financial Overview</h3>
                <p class="text-sm text-gray-600 mt-1">View and analyse council financial data</p>
              </div>
              <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 sm:items-center">
                <!-- Year Selector -->
                <div class="flex flex-col sm:flex-row sm:items-center gap-2">
                  <label for="year-select" class="text-sm font-medium text-gray-700 whitespace-nowrap">Financial Year:</label>
                  <select id="year-select" class="border border-gray-300 rounded-md px-3 py-3 bg-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 min-h-[44px]">
                    {% for y in years %}
                      <option value="{{ y.label }}" {% if y.label == selected_year.label %}selected{% endif %}>{{ y.display }}</option>
                    {% endfor %}
                  </select>
                </div>
                
                <!-- Customize Button -->
                <button id="drawer-toggle" 
                        class="inline-flex items-center justify-center px-4 py-3 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 active:bg-gray-100 transition-colors min-h-[44px]">
                  <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                  </svg>
                  Customise
                </button>
                
                {% if user.is_authenticated %}
                  <!-- Flag Data Issue Button -->
                  <button type="button"
                          class="flag-content-btn inline-flex items-center justify-center px-4 py-3 border border-orange-300 text-sm font-medium rounded-md text-orange-700 bg-orange-50 hover:bg-orange-100 active:bg-orange-200 transition-colors min-h-[44px]"
                          data-content-type="council_financial_data"
                          data-object-id="{{ council.slug }}"
                          data-content-description="{{ council.name }} financial data"
                          title="Report an issue with this council's financial data">
                    <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"/>
                    </svg>
                    Flag Data Issue
                  </button>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- Mobile/Desktop Collapsible Content -->
          <div id="financial-overview-content" class="hidden md:block overflow-hidden transition-all duration-300 ease-in-out">
            <div class="md:hidden border-b border-gray-200">
              <div class="px-4 py-4 space-y-4">
                <!-- Mobile Year Selector -->
                <div class="flex flex-col gap-2">
                  <label for="mobile-year-select" class="text-sm font-medium text-gray-700">Financial Year:</label>
                  <select id="mobile-year-select" class="border border-gray-300 rounded-md px-3 py-3 bg-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 min-h-[44px]">
                    {% for y in years %}
                      <option value="{{ y.label }}" {% if y.label == selected_year.label %}selected{% endif %}>{{ y.display }}</option>
                    {% endfor %}
                  </select>
                </div>
                
                <!-- Mobile Buttons -->
                <div class="flex flex-col gap-3">
                  <!-- Mobile Customize Button -->
                  <button id="mobile-drawer-toggle" 
                          class="inline-flex items-center justify-center px-4 py-3 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 active:bg-gray-100 transition-colors min-h-[44px] w-full">
                    <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    </svg>
                    Customise View
                  </button>
                  
                  {% if user.is_authenticated %}
                    <!-- Mobile Flag Data Issue Button -->
                    <button type="button"
                            class="flag-content-btn inline-flex items-center justify-center px-4 py-3 border border-orange-300 text-sm font-medium rounded-md text-orange-700 bg-orange-50 hover:bg-orange-100 active:bg-orange-200 transition-colors min-h-[44px] w-full"
                            data-content-type="council_financial_data"
                            data-object-id="{{ council.slug }}"
                            data-content-description="{{ council.name }} financial data"
                            title="Report an issue with this council's financial data">
                      <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"/>
                      </svg>
                      Flag Data Issue
                    </button>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- Expandable Settings Panel -->
          <div id="counter-drawer" class="overflow-hidden max-h-0 transition-all duration-300 ease-in-out">
            <div class="p-4 sm:p-6 border-t border-gray-200 bg-gray-50">
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Counter Selection -->
                <div class="space-y-4">
                  <div class="flex items-center justify-between">
                    <h4 class="text-base font-semibold text-gray-900">Select Counters</h4>
                    <span class="text-sm text-gray-500">Choose which metrics to display</span>
                  </div>
                  
                  <form class="space-y-3 max-h-64 overflow-y-auto" onsubmit="return false;">
                    {% for item in counters %}
                      <label class="flex items-center space-x-3 p-3 bg-white rounded-lg border border-gray-200 hover:bg-gray-50 cursor-pointer transition-colors">
                        <input type="checkbox" 
                               data-slug="{{ item.counter.slug }}" 
                               class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <div class="flex-1">
                          <div class="text-sm font-medium text-gray-900">{{ item.counter.name }}</div>
                          {% if item.counter.explanation %}
                            <div class="text-xs text-gray-500 mt-1">{{ item.counter.explanation|truncatechars:60 }}</div>
                          {% endif %}
                        </div>
                      </label>
                    {% endfor %}
                  </form>
                  
                  <div class="flex gap-3 mt-6">
                    <button id="drawer-apply" 
                            class="flex-1 inline-flex items-center justify-center px-4 py-3 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 transition-colors min-h-[44px]">
                      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                      </svg>
                      Apply Changes
                    </button>
                    <button id="drawer-reset" 
                            class="inline-flex items-center px-4 py-3 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors min-h-[44px]">
                      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                      </svg>
                      Reset
                    </button>
                  </div>
                </div>

                <!-- Display Settings -->
                <div class="space-y-6">
                  <div class="flex items-center justify-between">
                    <h4 class="text-base font-semibold text-gray-900">Display Settings</h4>
                    <span class="text-sm text-gray-500">Customize appearance</span>
                  </div>
                  
                  <div class="space-y-4">
                    <!-- Layout Settings -->
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                      <h5 class="text-sm font-medium text-gray-900 mb-3">Layout</h5>
                      <div class="space-y-3">
                        <div class="flex items-center justify-between">
                          <label for="column-slider" class="text-sm text-gray-700">Columns per row</label>
                          <div class="flex items-center space-x-3">
                            <input id="column-slider" type="range" min="1" max="4" step="1" class="w-24 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <span id="column-count" class="text-sm font-medium text-gray-900 w-4">3</span>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Number Formatting -->
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                      <h5 class="text-sm font-medium text-gray-900 mb-3">Number Formatting</h5>
                      <div class="space-y-3">
                        <div class="flex items-center justify-between">
                          <label for="precision-select" class="text-sm text-gray-700">Decimal places</label>
                          <select id="precision-select" class="border border-gray-300 rounded-md px-2 py-1 text-sm">
                            <option value="">Default</option>
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                          </select>
                        </div>
                        
                        <div class="flex items-center justify-between">
                          <label for="thousands-check" class="text-sm text-gray-700">Thousands separator</label>
                          <input type="checkbox" id="thousands-check" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        </div>
                        
                        <div class="flex items-center justify-between">
                          <label for="friendly-check" class="text-sm text-gray-700">Friendly format (K, M, B)</label>
                          <input type="checkbox" id="friendly-check" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        </div>
                      </div>
                    </div>

                    <!-- Share Settings -->
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                      <h5 class="text-sm font-medium text-gray-900 mb-3">Share This View</h5>
                      <p class="text-xs text-gray-600 mb-3">Generate a link that preserves your current settings</p>
                      <div class="space-y-2">
                        <button id="share-link" 
                                class="w-full inline-flex items-center justify-center px-3 py-2 border border-blue-300 text-sm font-medium rounded-md text-blue-700 bg-blue-50 hover:bg-blue-100 transition-colors">
                          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"/>
                          </svg>
                          Generate Share Link
                        </button>
                        <input type="text" id="share-url" readonly 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm bg-gray-50 text-gray-600">
                        <button id="copy-share-link" 
                                class="w-full inline-flex items-center justify-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                          </svg>
                          Copy Link
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Financial Counters Grid -->
        {% if counters %}
          <div id="counters-grid" class="counter-grid-container">
            {% for item in counters %}
              <div id="counter-{{ item.counter.slug }}" 
                   class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden hover:shadow-md transition-all duration-200 {% if item.counter.headline %}headline-counter{% endif %}" 
                   data-counter="{{ item.counter.slug }}">
                
                <!-- Counter Header -->
                <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                  <div class="flex items-center justify-between">
                    <h4 class="text-sm font-semibold text-gray-900">{{ item.counter.name }}</h4>
                    <div class="flex items-center gap-2">
                      <div class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-50 text-gray-600 opacity-60">
                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                        </svg>
                        <span class="financial-year-display">{{ selected_year.label }}</span>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Counter Content -->
                <div class="px-4 sm:px-6 py-4 sm:py-6 md:py-8 text-center">
                  <!-- Error Display -->
                  <div class="counter-error text-red-600 text-sm mb-4 {% if not item.error %}hidden{% endif %}">
                    <div class="inline-flex items-center px-3 py-2 rounded-lg bg-red-50 border border-red-200">
                      <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                      </svg>
                      {{ item.error }}
                    </div>
                  </div>

                  <!-- Value Display -->
                  <div class="{% if item.counter.headline %}text-4xl sm:text-5xl{% else %}text-2xl sm:text-3xl{% endif %} font-bold text-gray-900 counter-value mb-2 sm:mb-3"
                       {% if item.value is not None %}
                       data-duration="{{ item.counter.duration }}"
                       data-value="{{ item.value }}"
                       data-formatted="{{ item.formatted }}"
                       {% endif %}
                       data-precision="{{ item.counter.precision }}"
                       data-show-currency="{{ item.counter.show_currency|yesno:'true,false' }}"
                       data-friendly="{{ item.counter.friendly_format|yesno:'true,false' }}"
                       {% if item.error %}style="display:none"{% endif %}>
                    {% if item.value is not None %}{{ item.formatted }}{% else %}No data{% endif %}
                  </div>


                  <!-- Explanation -->
                  {% if item.counter.explanation %}
                    <p class="text-xs text-gray-500 mt-2 sm:mt-3 leading-relaxed">{{ item.counter.explanation }}</p>
                  {% endif %}
                </div>

                {% with sid='factoids-'|add:item.counter.slug %}
                {{ item.factoids|json_script:sid }}
                {% endwith %}
              </div>
            {% endfor %}
          </div>
        {% endif %}

        <!-- Meta Values Section -->
        {% if meta_values %}
          <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
            <div class="px-6 py-4 border-b border-gray-200">
              <h3 class="text-lg font-semibold text-gray-900">Additional Information</h3>
              <p class="text-sm text-gray-600 mt-1">Other relevant council data</p>
            </div>
            <div class="p-6">
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for m in meta_values %}
                  <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                    <p class="text-sm font-medium text-gray-900">{{ m.field.name|capfirst }}</p>
                    <p class="text-2xl font-bold text-green-700 mt-2">{{ m.value }}</p>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        {% endif %}
      </div>

    </div>
</div>

<!-- Load JavaScript files and functionality -->
{{ default_counter_slugs|json_script:"default-slugs" }}
{% if share_data %}{{ share_data|json_script:"share-data" }}{% endif %}

<script src="{% static 'js/countUp.umd.js' %}"></script>
<link rel="stylesheet" href="{% static 'css/factoid-system.css' %}">
<script src="{% static 'js/factoid-playlist.js' %}"></script>

<script>
// Pass authentication status to JavaScript  
window.djangoContext = {
    isAuthenticated: {{ request.user.is_authenticated|yesno:"true,false" }},
    userId: {{ request.user.id|default:"null" }}
};

document.addEventListener('DOMContentLoaded', function() {
// All the existing JavaScript functionality from the original template
// (keeping the same functions but with updated styling)

function getCookie(name){const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');return m?m.pop():'';}

// Authentication helper functions
function checkAuthentication() {
    // Use Django-provided authentication status if available
    if (window.djangoContext && typeof window.djangoContext.isAuthenticated === 'boolean') {
        return window.djangoContext.isAuthenticated;
    }
    
    // Fallback: Check if user is authenticated by looking for authenticated user indicators
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    const logoutLink = document.querySelector('a[href*="logout"]');
    const userDropdown = document.querySelector('.user-dropdown, [data-dropdown="user"]');
    const authUserElement = document.querySelector('.auth-user, .user-info');
    
    // If we have CSRF token and logout link, user is likely authenticated
    return !!(csrfToken && csrfToken.value && logoutLink) || 
           !!(userDropdown || authUserElement);
}

function showLoginPrompt(action) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-xl max-w-md w-full mx-4 p-6">
            <div class="text-center">
                <div class="mx-auto w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Sign in required</h3>
                <p class="text-gray-600 mb-6">You need to be logged in to ${action}.</p>
                
                <div class="space-y-3">
                    <a href="/login/" class="block w-full bg-blue-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                        Log In
                    </a>
                    <a href="/register/" class="block w-full border border-gray-300 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-50 transition-colors">
                        Create Account
                    </a>
                    <button onclick="this.closest('.fixed').remove()" 
                            class="block w-full text-gray-500 hover:text-gray-700 transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Close on backdrop click
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

// Follow button functionality  
const followBtn=document.getElementById('follow-btn');
if(followBtn){
  const csrftoken=getCookie('csrftoken');
  followBtn.addEventListener('click',()=>{
    // Check authentication first
    if (!checkAuthentication()) {
      showLoginPrompt('follow councils');
      return;
    }
    
    const slug=followBtn.dataset.slug;
    const following=followBtn.dataset.following==='true';
    const url=following?`/unfollow/${slug}/`:`/follow/${slug}/`;
    fetch(url,{method:'POST',headers:{'X-CSRFToken':csrftoken}}).then(r=>r.json()).then(data=>{
      if(data.status === 'success') {
        // Update data attribute
        followBtn.dataset.following=following?'false':'true';
        
        // Update button text
        const span = followBtn.querySelector('span');
        span.textContent = following ? 'Follow' : 'Unfollow';
        
        // Update button class
        if(following) {
          followBtn.classList.remove('gov-uk-button--warning');
        } else {
          followBtn.classList.add('gov-uk-button--warning');
        }
        
        // Update SVG icon
        const svg = followBtn.querySelector('svg path');
        if(following) {
          // Show plus icon for Follow
          svg.setAttribute('d', 'M12 6v6m0 0v6m0-6h6m-6 0H6');
        } else {
          // Show minus icon for Unfollow  
          svg.setAttribute('d', 'M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z');
        }
      }
    }).catch(err => {
      console.error('Follow/unfollow failed:', err);
    });
  });
}

// Compare button functionality
const compareBtn=document.getElementById('compare-btn');
if(compareBtn){
  const csrftoken=getCookie('csrftoken');
  compareBtn.addEventListener('click',()=>{
    // Check authentication first
    if (!checkAuthentication()) {
      showLoginPrompt('compare councils');
      return;
    }
    
    const slug=compareBtn.dataset.slug;
    fetch(`/compare/add/${slug}/`,{
      method:'POST',
      headers:{'X-CSRFToken':csrftoken}
    })
    .then(r=>r.json())
    .then(data=>{
      if(data.status==='success'){
        compareBtn.style.backgroundColor='#10b981';
        compareBtn.textContent=`Added (${data.count})`;
        
        const basketCount=document.querySelector('.compare-count');
        if(basketCount){
          basketCount.textContent=data.count;
          basketCount.parentElement.style.display=data.count>0?'flex':'none';
        }
        
        setTimeout(()=>{
          compareBtn.style.backgroundColor='#7c3aed';
          compareBtn.textContent='Compare';
        },2000);
      } else {
        compareBtn.style.backgroundColor='#ef4444';
        compareBtn.textContent=data.message||'Error';
        setTimeout(()=>{
          compareBtn.style.backgroundColor='#7c3aed';
          compareBtn.textContent='Compare';
        },2000);
      }
    })
    .catch(()=>{
      compareBtn.style.backgroundColor='#ef4444';
      compareBtn.textContent='Error';
      setTimeout(()=>{
        compareBtn.style.backgroundColor='#7c3aed';
        compareBtn.textContent='Compare';
      },2000);
    });
  });
}

// Counter animation and management functions
function animateCounters() {
  document.querySelectorAll('.counter-value').forEach(el => {
    if (!el.dataset.value) return;
    const end = parseFloat(el.dataset.value || '0');
    const dur = parseInt(el.dataset.duration || '0') / 1000;
    const display = el.dataset.formatted || end.toLocaleString();
    
    const showCurrency = (el.dataset.showCurrency || 'false').toLowerCase() === 'true';
    const precision = overridePrecision !== null ? parseInt(overridePrecision, 10)
      : parseInt(el.dataset.precision || '0', 10);
    const thousands = overrideThousands !== null ? overrideThousands === 'true'
      : showCurrency;
    
    // Check if friendly format is enabled for this counter
    const baseFriendly = (el.dataset.friendly || 'false').toLowerCase() === 'true';
    const friendly = overrideFriendly !== null ? (overrideFriendly === 'true') : baseFriendly;

    // If friendly format is enabled, handle formatting manually after animation
    if (friendly) {
      // For friendly format, use a simplified counter without currency/separator formatting
      // since we'll apply the friendly format manually at the end
      const cu = new countUp.CountUp(el, end, {
        duration: dur,
        decimalPlaces: 0, // Use 0 decimals during animation for cleaner look
        separator: '',     // No separators during animation
        prefix: '',        // No prefix during animation
        easingFn: (t, b, c, d) => {
          t /= d; return c * (2 - t) * t * 0.5 + b;
        }
      });
      
      if (cu.printValue) {
        cu.printValue(0);
      } else {
        el.textContent = cu.formattingFn(0);
      }
      
      if (!cu.error) {
        cu.start(() => {
          // Animation completed - now apply friendly format
          const counter = {
            showCurrency: el.dataset.showCurrency,
            precision: el.dataset.precision,
            friendly: el.dataset.friendly,
          };
          el.textContent = formatValue(end, counter);
        });
      } else {
        el.textContent = display;
      }
    } else {
      // Use standard CountUp formatting for non-friendly format
      const cu = new countUp.CountUp(el, end, {
        duration: dur,
        decimalPlaces: precision,
        separator: thousands ? ',' : '',
        prefix: showCurrency ? '£' : '',
        easingFn: (t, b, c, d) => {
          t /= d; return c * (2 - t) * t * 0.5 + b;
        }
      });
      
      if (cu.printValue) {
        cu.printValue(0);
      } else {
        el.textContent = cu.formattingFn(0);
      }
      
      if (!cu.error) {
        cu.start(() => {
          // Counter animation completed, factoid will be automatically initialized
          // by the factoid-playlist.js system
        });
      } else {
        el.textContent = display;
      }
    }
  });
}

async function loadCounters(year) {
  const url = `{% url 'council_counters' council.slug %}?year=${encodeURIComponent(year)}`;
  try {
    const resp = await fetch(url, {headers: {'X-Requested-With': 'XMLHttpRequest'}});
    const data = await resp.json();
    Object.entries(data.counters).forEach(([slug, info]) => {
      const container = document.querySelector(`[data-counter="${slug}"]`);
      if (!container) return;
      const valEl = container.querySelector('.counter-value');
      const errEl = container.querySelector('.counter-error');
      if (info.error) {
        if (errEl) { errEl.textContent = info.error; errEl.classList.remove('hidden'); }
        if (valEl) { valEl.style.display = 'none'; }
      } else {
        if (errEl) { errEl.textContent = ''; errEl.classList.add('hidden'); }
        if (valEl) {
          if (info.value === null) {
            valEl.removeAttribute('data-value');
            valEl.removeAttribute('data-formatted');
            valEl.textContent = 'No data';
          } else {
            valEl.dataset.value = info.value;
            valEl.dataset.formatted = info.formatted;
            valEl.textContent = '0';
          }
          valEl.dataset.duration = info.duration;
          valEl.dataset.precision = info.precision;
          valEl.dataset.showCurrency = info.show_currency;
          valEl.dataset.friendly = info.friendly_format;
          valEl.style.display = '';
        }
      }
    });
    formatAllCounters();
    animateCounters();
  } catch (e) {
    console.error('Failed to load counters', e);
  }
}

// Mobile Financial Overview accordion functionality
const mobileFinancialToggle = document.getElementById('mobile-financial-toggle');
const financialOverviewContent = document.getElementById('financial-overview-content');
const mobileToggleIcon = document.getElementById('mobile-toggle-icon');

if (mobileFinancialToggle && financialOverviewContent) {
  mobileFinancialToggle.addEventListener('click', () => {
    const isExpanded = mobileFinancialToggle.getAttribute('aria-expanded') === 'true';
    const newExpanded = !isExpanded;
    
    // Toggle aria-expanded attribute
    mobileFinancialToggle.setAttribute('aria-expanded', newExpanded.toString());
    
    // Toggle content visibility
    if (newExpanded) {
      financialOverviewContent.classList.remove('hidden');
      mobileToggleIcon.style.transform = 'rotate(180deg)';
    } else {
      financialOverviewContent.classList.add('hidden');
      mobileToggleIcon.style.transform = 'rotate(0deg)';
    }
  });
}

// Sync mobile and desktop year selectors
const yearSelect = document.getElementById('year-select');
const mobileYearSelect = document.getElementById('mobile-year-select');
if (yearSelect && mobileYearSelect) {
  // Sync desktop -> mobile
  yearSelect.addEventListener('change', () => {
    mobileYearSelect.value = yearSelect.value;
  });
  
  // Sync mobile -> desktop
  mobileYearSelect.addEventListener('change', (e) => {
    yearSelect.value = e.target.value;
    const newYear = e.target.value;
    loadCounters(newYear);
    
    // Update financial year pills in counter headers
    document.querySelectorAll('.financial-year-display').forEach(yearDisplay => {
      yearDisplay.textContent = newYear;
    });
    
    // Year changed - AI factoids will automatically refresh when cache expires
    console.log(`📅 Year changed to ${newYear} - AI factoids will refresh automatically`);
  });
}

// Mobile drawer toggle (sync with desktop)
const mobileDrawerToggle = document.getElementById('mobile-drawer-toggle');
const mobileDrawer = document.getElementById('counter-drawer'); // Use different name to avoid conflict
if (mobileDrawerToggle && mobileDrawer) {
  mobileDrawerToggle.addEventListener('click', () => {
    if (mobileDrawer.style.maxHeight && mobileDrawer.style.maxHeight !== '0px') {
      mobileDrawer.style.maxHeight = '0px';
    } else {
      mobileDrawer.style.maxHeight = mobileDrawer.scrollHeight + 'px';
    }
  });
}

if (yearSelect) {
  yearSelect.addEventListener('change', e => {
    const newYear = e.target.value;
    loadCounters(newYear);
    
    // Update financial year pills in counter headers
    document.querySelectorAll('.financial-year-display').forEach(yearDisplay => {
      yearDisplay.textContent = newYear;
    });
    
    // Year changed - AI factoids will automatically refresh when cache expires
    console.log(`📅 Year changed to ${newYear} - AI factoids will refresh automatically`);
  });
}

const councilSlug = '{{ council.slug }}';
const grid = document.getElementById('counters-grid');
const slider = document.getElementById('column-slider');
const drawer = document.getElementById('counter-drawer');
const toggleBtn = document.getElementById('drawer-toggle');
const applyBtn = document.getElementById('drawer-apply');
const resetBtn = document.getElementById('drawer-reset');
const precisionSelect = document.getElementById('precision-select');
const thousandsCheck = document.getElementById('thousands-check');
const friendlyCheck = document.getElementById('friendly-check');

let overridePrecision = localStorage.getItem(`precision_${councilSlug}`);
let overrideThousands = localStorage.getItem(`thousands_${councilSlug}`);
let overrideFriendly = localStorage.getItem(`friendly_${councilSlug}`);

const shareEl = document.getElementById('share-data');
let sharePrefs = null;
if (shareEl) {
  try { sharePrefs = JSON.parse(shareEl.textContent); } catch (e) { sharePrefs = null; }
}
if (sharePrefs) {
  if (sharePrefs.precision !== undefined && sharePrefs.precision !== null) {
    overridePrecision = sharePrefs.precision;
    localStorage.setItem(`precision_${councilSlug}`, sharePrefs.precision);
  }
  if (sharePrefs.thousands !== undefined) {
    overrideThousands = sharePrefs.thousands ? 'true' : 'false';
    localStorage.setItem(`thousands_${councilSlug}`, overrideThousands);
  }
  if (sharePrefs.friendly !== undefined) {
    overrideFriendly = sharePrefs.friendly ? 'true' : 'false';
    localStorage.setItem(`friendly_${councilSlug}`, overrideFriendly);
  }
  if (Array.isArray(sharePrefs.counters)) {
    localStorage.setItem(`counters_${councilSlug}`, JSON.stringify(sharePrefs.counters));
  }
  if (sharePrefs.year) {
    document.getElementById('year-select').value = sharePrefs.year;
  }
}

if (overridePrecision !== null) precisionSelect.value = overridePrecision;
if (overrideThousands !== null) thousandsCheck.checked = overrideThousands === 'true';
if (overrideFriendly !== null) friendlyCheck.checked = overrideFriendly === 'true';

function defaultCols() {
  if (window.innerWidth < 640) return 1;
  if (window.innerWidth < 768) return 2;
  return 3;
}

function setCols(n) {
  document.getElementById('column-count').textContent = n;
  grid.style.gridTemplateColumns = `repeat(${n}, minmax(0,1fr))`;
}

function formatNumber(value, precision, thousands) {
  let num = Number(value);
  if (thousands) {
    return num.toLocaleString(undefined, {
      minimumFractionDigits: precision,
      maximumFractionDigits: precision
    });
  }
  return num.toFixed(precision);
}

function formatValue(value, counter) {
  const showCurrency = (counter.showCurrency || 'false').toLowerCase() === 'true';
  const basePrecision = parseInt(counter.precision || '0', 10);
  const baseFriendly = (counter.friendly || 'false').toLowerCase() === 'true';

  const precision = overridePrecision !== null ? parseInt(overridePrecision, 10) : basePrecision;
  const friendly = overrideFriendly !== null ? (overrideFriendly === 'true') : baseFriendly;
  const thousands = overrideThousands !== null ? (overrideThousands === 'true') : showCurrency;

  let result = '';
  let val = Number(value);
  if (friendly) {
    let suffix = '';
    let displayVal = val;
    const absVal = Math.abs(val);
    if (absVal >= 1e9) { displayVal = val / 1e9; suffix = 'b'; }
    else if (absVal >= 1e6) { displayVal = val / 1e6; suffix = 'm'; }
    else if (absVal >= 1e3) { displayVal = val / 1e3; suffix = 'k'; }
    result = formatNumber(displayVal, precision, thousands) + suffix;
  } else {
    result = formatNumber(val, precision, thousands);
  }
  if (showCurrency) {
    result = '£' + result;
  }
  return result;
}

function formatAllCounters() {
  document.querySelectorAll('.counter-value').forEach(el => {
    if (!el.dataset.value) return;
    const counter = {
      showCurrency: el.dataset.showCurrency,
      precision: el.dataset.precision,
      friendly: el.dataset.friendly,
    };
    el.dataset.formatted = formatValue(el.dataset.value, counter);
  });
}

const storedCols = localStorage.getItem(`cols_${councilSlug}`);
const cols = storedCols ? parseInt(storedCols, 10) : defaultCols();
slider.value = cols;
setCols(cols);

slider.addEventListener('input', e => {
  const val = parseInt(e.target.value, 10);
  setCols(val);
  localStorage.setItem(`cols_${councilSlug}`, val);
});

function saveFormatting() {
  overridePrecision = precisionSelect.value || null;
  overrideThousands = thousandsCheck.checked ? 'true' : 'false';
  overrideFriendly = friendlyCheck.checked ? 'true' : 'false';
  if (overridePrecision !== null && overridePrecision !== '') {
    localStorage.setItem(`precision_${councilSlug}`, overridePrecision);
  } else {
    localStorage.removeItem(`precision_${councilSlug}`);
    overridePrecision = null;
  }
  localStorage.setItem(`thousands_${councilSlug}`, overrideThousands);
  localStorage.setItem(`friendly_${councilSlug}`, overrideFriendly);
  formatAllCounters();
  animateCounters();
}

precisionSelect.addEventListener('change', saveFormatting);
thousandsCheck.addEventListener('change', saveFormatting);
friendlyCheck.addEventListener('change', saveFormatting);

const defaultSlugs = JSON.parse(document.getElementById('default-slugs').textContent);

function applyPrefs(slugs) {
  document.querySelectorAll('#counter-drawer input[type=checkbox]').forEach(cb => {
    cb.checked = slugs.includes(cb.dataset.slug);
  });
  document.querySelectorAll('#counters-grid [data-counter]').forEach(div => {
    div.style.display = slugs.includes(div.dataset.counter) ? '' : 'none';
  });
  formatAllCounters();
  animateCounters();
}

let savedSlugs;
try {
  savedSlugs = JSON.parse(localStorage.getItem(`counters_${councilSlug}`));
} catch (err) { savedSlugs = null; }
applyPrefs(savedSlugs || defaultSlugs);

applyBtn.addEventListener('click', () => {
  const selected = Array.from(document.querySelectorAll('#counter-drawer input[type=checkbox]:checked')).map(cb => cb.dataset.slug);
  localStorage.setItem(`counters_${councilSlug}`, JSON.stringify(selected));
  applyPrefs(selected);
  drawer.style.maxHeight = '0px';
});

resetBtn.addEventListener('click', () => {
  localStorage.removeItem(`counters_${councilSlug}`);
  applyPrefs(defaultSlugs);
  drawer.style.maxHeight = '0px';
});

toggleBtn.addEventListener('click', () => {
  if (drawer.style.maxHeight && drawer.style.maxHeight !== '0px') {
    drawer.style.maxHeight = '0px';
  } else {
    drawer.style.maxHeight = drawer.scrollHeight + 'px';
  }
});

// Share link functionality
document.getElementById('share-link').addEventListener('click', async () => {
  const endpoint = new URL('{% url "generate_share_link" council.slug %}', window.location.origin);
  const year = document.getElementById('year-select').value;
  const selectedCounters = Array.from(document.querySelectorAll('#counters-grid [data-counter]'))
    .filter(el => el.style.display !== 'none')
    .map(el => el.dataset.counter);
  endpoint.searchParams.set('year', year);
  endpoint.searchParams.set('counters', selectedCounters.join(','));
  endpoint.searchParams.set('precision', precisionSelect.value || '');
  endpoint.searchParams.set('thousands', thousandsCheck.checked);
  endpoint.searchParams.set('friendly', friendlyCheck.checked);
  try {
    const resp = await fetch(endpoint, {headers: {'X-Requested-With': 'XMLHttpRequest'}});
    const data = await resp.json();
    document.getElementById('share-url').value = data.url || '';
  } catch (e) {
    document.getElementById('share-url').value = 'Error generating link';
  }
});

document.getElementById('copy-share-link').addEventListener('click', () => {
  const shareUrl = document.getElementById('share-url');
  shareUrl.select();
  document.execCommand('copy');
  alert('Shareable link copied to clipboard!');
});

// Initialize on page load
formatAllCounters();
animateCounters();

// End of counter functionality

}); // End DOMContentLoaded
</script>

<style>
/* Enhanced dropdown animation and visual polish */
#counter-drawer {
  overflow: hidden;
  max-height: 0;
  transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out;
}

#counter-drawer.expanded {
  max-height: 1000px; /* Large enough for content */
}

/* Counter grid responsive adjustments */
#counters-grid {
  transition: grid-template-columns 0.2s ease-in-out;
}

/* Counter Grid Layout - Custom CSS to override Tailwind conflicts */
.counter-grid-container {
  display: grid;
  gap: 1.5rem;
  grid-template-columns: 1fr; /* Single column on mobile */
}

/* Headline counters always span full width */
.counter-grid-container .headline-counter {
  grid-column: 1 / -1;
}

/* Mobile-specific improvements */
@media (max-width: 768px) {
  /* Ensure single column layout on mobile */
  .counter-grid-container {
    grid-template-columns: 1fr !important;
    gap: 1rem;
  }
  
  /* Fix counter spacing issues on mobile - more aggressive spacing reduction */
  .counter-value {
    line-height: 1.1;
    margin-bottom: 0.5rem !important; /* Reduced from 0.75rem */
  }
  
  /* Reduce excessive padding in counters */
  #counters-grid .px-6 {
    padding-left: 1rem !important;
    padding-right: 1rem !important;
  }
  
  /* Improve counter explanation text spacing - less space */
  #counters-grid p.text-xs {
    margin-top: 0.5rem !important; /* Reduced from 0.75rem */
    line-height: 1.4;
  }
  
  /* Mobile Financial Overview accordion */
  #mobile-financial-toggle {
    transition: background-color 0.2s ease;
  }
  
  #mobile-financial-toggle:active {
    background-color: #f3f4f6;
  }
  
  #mobile-toggle-icon {
    transition: transform 0.3s ease;
  }
  
  /* Ensure proper touch targets on mobile */
  button, .btn, [role="button"] {
    min-height: 44px;
    min-width: 44px;
  }
  
  /* Improve button spacing on mobile */
  .space-y-3 > * + * {
    margin-top: 0.75rem;
  }
  
  .gap-3 {
    gap: 0.75rem;
  }
  
  /* Fix select element sizing on mobile */
  select {
    min-height: 44px;
  }
  
  /* Mobile counter header padding adjustment */
  #counters-grid .px-6.py-4 {
    padding: 0.75rem 1rem;
  }
}

/* Desktop layout refinements */
@media (min-width: 1280px) {
  /* Fixed desktop layout width */
  .max-w-desktop {
    max-width: 1280px !important;
    margin-left: auto;
    margin-right: auto;
  }
  
  /* Restore 3-column grid layout on desktop */
  .counter-grid-container {
    grid-template-columns: repeat(3, 1fr) !important;
    gap: 1.5rem;
  }
  
  /* Desktop-specific button adjustments */
  .btn-group button {
    min-height: auto;
  }
}
</style>

{% endblock %}
<!-- AI Analysis sidebar removed for mobile-first design -->