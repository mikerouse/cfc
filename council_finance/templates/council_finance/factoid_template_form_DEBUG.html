{% extends "base.html" %}
{% load i18n %}

{% block title %}
    TEMPLATE FILE LOADED CORRECTLY - {% if template %}Edit Factoid Template{% else %}Add Factoid Template{% endif %} - Council Finance Counters
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6 max-w-4xl">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">
            ðŸš¨ CORRECT TEMPLATE FILE LOADED ðŸš¨ {% if template %}Edit Factoid Template{% else %}Create New Factoid Template{% endif %}
        </h1>
        <p class="text-gray-600">
            Factoid templates generate dynamic insights that appear beneath counters with contextual data.
        </p>
        
        <!-- COMPREHENSIVE DEBUG INFO -->
        <div class="bg-red-50 border border-red-200 p-4 rounded mt-4">
            <h3 class="font-bold text-red-700">DEBUG INFO</h3>
            <div class="text-sm text-red-600 space-y-1">
                <div>Debug info exists: {{ debug_info|yesno:"YES,NO" }}</div>
                {% if debug_info %}
                    <div>Quick variables count: {{ debug_info.quick_count }}</div>
                    <div>All variables count: {{ debug_info.all_count }}</div>
                    <div>Characteristic fields: {{ debug_info.char_count }}</div>
                    <div>Calculated fields: {{ debug_info.calc_count }}</div>
                    <div>Financial fields: {{ debug_info.fin_count }}</div>
                {% endif %}
                <div>Quick variables length: {{ quick_variables|length }}</div>
                <div>All variables length: {{ all_template_variables|length }}</div>
                <div>Quick variables type: {{ quick_variables|slugify }}</div>
            </div>
        </div>
    </div>

    <form method="post" class="space-y-8">
        {% csrf_token %}
        
        <!-- Basic Information -->
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Basic Information</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-2">Template Name</label>
                    <input type="text" name="name" id="name" required
                           value="{{ template.name|default:'' }}"
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-emerald-500 focus:border-emerald-500"
                           placeholder="e.g. Year-over-year percentage change">
                </div>

                <div>
                    <label for="factoid_type" class="block text-sm font-medium text-gray-700 mb-2">Factoid Type</label>
                    <select name="factoid_type" id="factoid_type" required
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-emerald-500 focus:border-emerald-500">
                        {% for value, label in factoid_types %}
                            <option value="{{ value }}" {% if template.factoid_type == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="mt-6">
                <label for="template_text" class="block text-sm font-medium text-gray-700 mb-2">
                    Template Text
                    <span class="text-xs text-gray-500 ml-2">Use {{variable}} for dynamic content</span>
                </label>
                <textarea name="template_text" id="template_text" rows="3" required
                          class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-emerald-500 focus:border-emerald-500"
                          placeholder="{{change}}% {{change_direction}} vs last year ({{previous_formatted}} â†’ {{formatted}})">{{ template.template_text|default:'' }}</textarea>
                
                <!-- Enhanced Template Variables Panel -->
                <div class="mt-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-sm font-medium text-gray-700">Available Template Variables</h3>
                        <button type="button" id="toggle-variables" 
                                class="text-xs text-emerald-600 hover:text-emerald-800 font-medium">
                            Show All Variables
                        </button>
                    </div>
                    <!-- Quick variables (always visible) -->
                    <div id="quick-variables" class="flex flex-wrap gap-1 mb-2">
                        <!-- DEBUG: Quick variables iteration -->
                        {% for var in quick_variables %}
                            <button type="button" 
                                    class="variable-button inline-flex items-center px-2 py-1 text-xs bg-emerald-100 text-emerald-800 rounded hover:bg-emerald-200 cursor-pointer"
                                    data-variable="{{ var.display }}" 
                                    title="{{ var.description }}">
                                {{ var.display }}
                            </button>
                        {% empty %}
                            <div class="text-red-500 text-xs font-bold">NO QUICK VARIABLES FOUND IN TEMPLATE LOOP</div>
                        {% endfor %}
                        
                        <!-- Fallback debug if variables exist but aren't looping -->
                        {% if quick_variables and not quick_variables|length %}
                            <div class="text-orange-500 text-xs">Variables exist but length is 0</div>
                        {% endif %}
                    </div>
                    
                    <!-- All variables (collapsible) -->
                    <div id="all-variables" class="hidden border border-gray-200 rounded-lg p-3 max-h-60 overflow-y-auto bg-gray-50">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            {% for var in all_template_variables %}
                                {% if var.is_header %}
                                    <div class="col-span-full text-sm font-semibold text-gray-600 mt-3 mb-1 border-b border-gray-300 pb-1">
                                        {{ var.display|slice:"4:-4" }}  <!-- Remove --- --- wrapping -->
                                    </div>
                                {% else %}
                                    <button type="button" 
                                            class="variable-button text-left p-2 rounded hover:bg-emerald-100 border border-transparent hover:border-emerald-300 transition-colors"
                                            data-variable="{{ var.display }}" 
                                            title="{{ var.description }}">
                                        <div class="text-xs font-mono text-emerald-700">{{ var.display }}</div>
                                        <div class="text-xs text-gray-600 truncate">{{ var.description }}</div>
                                    </button>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Visual Properties -->
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Visual Properties</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="emoji" class="block text-sm font-medium text-gray-700 mb-2">Emoji</label>
                    <input type="text" name="emoji" id="emoji" maxlength="10"
                           value="{{ template.emoji|default:'' }}"
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-emerald-500 focus:border-emerald-500"
                           placeholder="ðŸ“Š">
                </div>

                <div>
                    <label for="color_scheme" class="block text-sm font-medium text-gray-700 mb-2">Color Scheme</label>
                    <select name="color_scheme" id="color_scheme"
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-emerald-500 focus:border-emerald-500">
                        {% for value, label in color_schemes %}
                            <option value="{{ value }}" {% if template.color_scheme == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label for="priority" class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                    <input type="number" name="priority" id="priority"
                           value="{{ template.priority|default:0 }}"
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-emerald-500 focus:border-emerald-500"
                           placeholder="0">
                    <div class="mt-1 text-xs text-gray-500">Higher values show first</div>
                </div>
            </div>

            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="animation_duration" class="block text-sm font-medium text-gray-700 mb-2">Animation Duration (ms)</label>
                    <input type="number" name="animation_duration" id="animation_duration" min="1000" max="30000"
                           value="{{ template.animation_duration|default:5000 }}"
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-emerald-500 focus:border-emerald-500">
                </div>

                <div class="flex items-center mt-8">
                    <input type="checkbox" name="flip_animation" id="flip_animation" 
                           {% if template.flip_animation %}checked{% endif %}
                           class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
                    <label for="flip_animation" class="ml-2 block text-sm text-gray-900">Enable flip animation</label>
                </div>
            </div>
        </div>

        <!-- Targeting -->
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Targeting</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Counters</label>
                    <div class="border border-gray-300 rounded-md p-3 max-h-40 overflow-y-auto">
                        {% for counter in counters %}
                            <label class="flex items-center mb-2">
                                <input type="checkbox" name="counters" value="{{ counter.id }}" 
                                       {% if counter in template.counters.all %}checked{% endif %}
                                       class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
                                <span class="ml-2 text-sm">{{ counter.name }}</span>
                            </label>
                        {% endfor %}
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Council Types</label>
                    <div class="border border-gray-300 rounded-md p-3 max-h-40 overflow-y-auto">
                        {% for council_type in council_types %}
                            <label class="flex items-center mb-2">
                                <input type="checkbox" name="council_types" value="{{ council_type.id }}" 
                                       {% if council_type in template.council_types.all %}checked{% endif %}
                                       class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
                                <span class="ml-2 text-sm">{{ council_type.name }}</span>
                            </label>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Conditions -->
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Display Conditions</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="min_value" class="block text-sm font-medium text-gray-700 mb-2">Minimum Value</label>
                    <input type="number" name="min_value" id="min_value" step="0.01"
                           value="{{ template.min_value|default:'' }}"
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-emerald-500 focus:border-emerald-500"
                           placeholder="Optional">
                </div>

                <div>
                    <label for="max_value" class="block text-sm font-medium text-gray-700 mb-2">Maximum Value</label>
                    <input type="number" name="max_value" id="max_value" step="0.01"
                           value="{{ template.max_value|default:'' }}"
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-emerald-500 focus:border-emerald-500"
                           placeholder="Optional">
                </div>
            </div>

            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="flex items-center">
                    <input type="checkbox" name="requires_previous_year" id="requires_previous_year" 
                           {% if template.requires_previous_year %}checked{% endif %}
                           class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
                    <label for="requires_previous_year" class="ml-2 block text-sm text-gray-900">Requires previous year data</label>
                </div>

                <div class="flex items-center">
                    <input type="checkbox" name="is_active" id="is_active" 
                           {% if template.is_active or not template %}checked{% endif %}
                           class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
                    <label for="is_active" class="ml-2 block text-sm text-gray-900">Active</label>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex gap-4 justify-end">
            <a href="{% url 'factoid_template_list' %}" 
               class="px-6 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 font-medium">
                Cancel
            </a>
            <button type="submit" 
                    class="px-6 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-md font-medium">
                {% if template %}Update Template{% else %}Create Template{% endif %}
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('FACTOID DEBUG: DOM loaded, starting JavaScript debug...');
    
    const templateTextArea = document.getElementById('template_text');
    const toggleButton = document.getElementById('toggle-variables');
    const allVariablesPanel = document.getElementById('all-variables');
    const quickVariablesPanel = document.getElementById('quick-variables');
    let allVariablesVisible = false;
    
    // Debug DOM elements
    console.log('FACTOID DEBUG: Template textarea found:', !!templateTextArea);
    console.log('FACTOID DEBUG: Toggle button found:', !!toggleButton);
    console.log('FACTOID DEBUG: All variables panel found:', !!allVariablesPanel);
    console.log('FACTOID DEBUG: Quick variables panel found:', !!quickVariablesPanel);
    
    // Debug variable buttons
    const variableButtons = document.querySelectorAll('.variable-button');
    console.log('FACTOID DEBUG: Variable buttons found:', variableButtons.length);
    
    if (quickVariablesPanel) {
        console.log('FACTOID DEBUG: Quick variables panel innerHTML length:', quickVariablesPanel.innerHTML.length);
        console.log('FACTOID DEBUG: Quick variables panel content preview:', quickVariablesPanel.innerHTML.substring(0, 200));
    }
    
    // Debug context data injection
    try {
        const debugData = {
            quickVariablesLength: {{ quick_variables|length|default:0 }},
            allVariablesLength: {{ all_template_variables|length|default:0 }},
            debugInfo: "{{ debug_info|default:'null' }}"
        };
        console.log('FACTOID DEBUG: Context data injected:', debugData);
    } catch (e) {
        console.error('FACTOID DEBUG: Error injecting context data:', e);
    }
    
    // Toggle all variables panel
    toggleButton.addEventListener('click', function() {
        allVariablesVisible = !allVariablesVisible;
        if (allVariablesVisible) {
            allVariablesPanel.classList.remove('hidden');
            toggleButton.textContent = 'Hide Variables';
        } else {
            allVariablesPanel.classList.add('hidden');
            toggleButton.textContent = 'Show All Variables';
        }
    });
    
    // Insert variable into template text when clicked
    document.querySelectorAll('.variable-button').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const variable = this.getAttribute('data-variable');
            
            // Get current cursor position
            const start = templateTextArea.selectionStart;
            const end = templateTextArea.selectionEnd;
            const currentValue = templateTextArea.value;
            
            // Insert variable at cursor position
            const newValue = currentValue.substring(0, start) + variable + currentValue.substring(end);
            templateTextArea.value = newValue;
            
            // Move cursor to end of inserted variable
            const newCursorPos = start + variable.length;
            templateTextArea.setSelectionRange(newCursorPos, newCursorPos);
            
            // Focus back on textarea
            templateTextArea.focus();
            
            // Add visual feedback
            this.classList.add('bg-emerald-200');
            setTimeout(() => {
                this.classList.remove('bg-emerald-200');
            }, 200);
        });
    });
    
    // Simple preview functionality placeholder
    templateTextArea.addEventListener('input', function() {
        // Could add live preview here in the future
    });
});
</script>
{% endblock %}