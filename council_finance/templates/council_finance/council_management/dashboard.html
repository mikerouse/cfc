{% extends "base.html" %}
{% load static %}
{% block title %}Council Management - Zeus God Mode - Council Finance Counters{% endblock %}

{% block content %}
<div class="min-h-screen" style="background: #f3f2f1;">
  <!-- GOV.UK-inspired Header -->
  <div style="background: #1d70b8; color: white; border-bottom: 2px solid #144e81;">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <nav class="flex py-3 text-sm" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-2">
          <li class="inline-flex items-center">
            <a href="{% url 'god_mode' %}" class="inline-flex items-center" style="color: #b3d1f2; text-decoration: none;" 
               onmouseover="this.style.color='white'" onmouseout="this.style.color='#b3d1f2'">
              <span style="margin-right: 8px;">🏠</span>
              Zeus God Mode
            </a>
          </li>
          <li style="color: #b3d1f2;">›</li>
          <li>
            <span style="color: white; font-weight: bold;">🏛️ Council Management</span>
          </li>
        </ol>
      </nav>
    </div>
  </div>

  <!-- GOV.UK-inspired Sub-Navigation -->
  <div style="background: white; border-bottom: 2px solid #b1b4b6;">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <nav class="flex space-x-4 py-3" aria-label="God Mode Navigation">
        <a href="{% url 'god_mode' %}" 
           class="px-4 py-2 text-sm font-medium" 
           style="color: #626a6e; text-decoration: none; border-radius: 0;"
           onmouseover="this.style.color='#1d70b8'; this.style.background='#f3f2f1'" 
           onmouseout="this.style.color='#626a6e'; this.style.background='transparent'">
          📊 Dashboard
        </a>
        <a href="{% url 'council_management_dashboard' %}" 
           class="px-4 py-2 text-sm font-medium" 
           style="color: #1d70b8; text-decoration: none; border-bottom: 4px solid #1d70b8; font-weight: bold;">
          🏛️ Council Management
        </a>
        <a href="{% url 'activity_log_entries' %}" 
           class="px-4 py-2 text-sm font-medium" 
           style="color: #626a6e; text-decoration: none; border-radius: 0;"
           onmouseover="this.style.color='#1d70b8'; this.style.background='#f3f2f1'" 
           onmouseout="this.style.color='#626a6e'; this.style.background='transparent'">
          📋 Activity Log
        </a>
        <a href="{% url 'event_viewer:dashboard' %}" 
           class="px-4 py-2 text-sm font-medium" 
           style="color: #626a6e; text-decoration: none; border-radius: 0;"
           onmouseover="this.style.color='#1d70b8'; this.style.background='#f3f2f1'" 
           onmouseout="this.style.color='#626a6e'; this.style.background='transparent'">
          🚨 Event Viewer
        </a>
      </nav>
    </div>
  </div>

  <!-- GOV.UK-style Page Header -->
  <div style="background: white; border-bottom: 2px solid #b1b4b6;">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="py-6">
        <div class="md:flex md:items-center md:justify-between">
          <div class="flex-1 min-w-0">
            <h1 style="font-size: 32px; font-weight: bold; color: #0b0c0c; margin: 0 0 8px 0; line-height: 1.2;">
              Council Management
            </h1>
            <p style="color: #626a6e; font-size: 16px; margin: 0;">
              Create, edit, and manage councils across the system
            </p>
            <div style="margin-top: 8px;">
              <span style="background: #1d70b8; color: white; padding: 4px 8px; font-size: 12px; font-weight: bold; text-transform: uppercase;">God Mode Access</span>
            </div>
          </div>
          <div class="mt-4 flex md:mt-0 md:ml-4 space-x-3">
            <a href="{% url 'import_councils' %}" 
               style="display: inline-flex; align-items: center; padding: 12px 20px; background: #00703c; color: white; font-size: 16px; font-weight: bold; text-decoration: none; border: 2px solid #00703c;"
               onmouseover="this.style.background='#005a30'" onmouseout="this.style.background='#00703c'">
              📥 Import Councils
            </a>
            <a href="{% url 'create_council' %}" 
               style="display: inline-flex; align-items: center; padding: 12px 20px; background: #1d70b8; color: white; font-size: 16px; font-weight: bold; text-decoration: none; border: 2px solid #1d70b8;"
               onmouseover="this.style.background='#144e81'" onmouseout="this.style.background='#1d70b8'">
              ➕ Create Council
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- GOV.UK-style Statistics Cards -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <div id="council-stats-total" style="background: white; border: 2px solid #b1b4b6; padding: 20px;">
        <div class="flex items-center">
          <div style="margin-right: 16px;">
            <div style="width: 48px; height: 48px; background: #1d70b8; color: white; display: flex; align-items: center; justify-content: center; font-size: 24px;">
              🏛️
            </div>
          </div>
          <div>
            <p style="font-size: 16px; font-weight: bold; color: #0b0c0c; margin: 0 0 4px 0;">Total Councils</p>
            <p style="font-size: 32px; font-weight: bold; color: #1d70b8; margin: 0;">{{ stats.total|default:"0" }}</p>
          </div>
        </div>
      </div>

      <div id="council-stats-active" style="background: white; border: 2px solid #b1b4b6; padding: 20px;">
        <div class="flex items-center">
          <div style="margin-right: 16px;">
            <div style="width: 48px; height: 48px; background: #00703c; color: white; display: flex; align-items: center; justify-content: center; font-size: 24px;">
              ✓
            </div>
          </div>
          <div>
            <p style="font-size: 16px; font-weight: bold; color: #0b0c0c; margin: 0 0 4px 0;">Active</p>
            <p style="font-size: 32px; font-weight: bold; color: #00703c; margin: 0;">{{ stats.active|default:"0" }}</p>
          </div>
        </div>
      </div>

      <div id="council-stats-inactive" style="background: white; border: 2px solid #b1b4b6; padding: 20px;">
        <div class="flex items-center">
          <div style="margin-right: 16px;">
            <div style="width: 48px; height: 48px; background: #f47738; color: white; display: flex; align-items: center; justify-content: center; font-size: 24px;">
              ⚠️
            </div>
          </div>
          <div>
            <p style="font-size: 16px; font-weight: bold; color: #0b0c0c; margin: 0 0 4px 0;">Inactive</p>
            <p style="font-size: 32px; font-weight: bold; color: #f47738; margin: 0;">{{ stats.inactive|default:"0" }}</p>
          </div>
        </div>
      </div>

      <div id="council-stats-data" style="background: white; border: 2px solid #b1b4b6; padding: 20px;">
        <div class="flex items-center">
          <div style="margin-right: 16px;">
            <div style="width: 48px; height: 48px; background: #144e81; color: white; display: flex; align-items: center; justify-content: center; font-size: 24px;">
              📋
            </div>
          </div>
          <div>
            <p style="font-size: 16px; font-weight: bold; color: #0b0c0c; margin: 0 0 4px 0;">With Data</p>
            <p style="font-size: 32px; font-weight: bold; color: #144e81; margin: 0;">{{ stats.with_data|default:"0" }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- GOV.UK-style Search and Filter Section -->
    <div id="council-search-section" style="background: white; border: 2px solid #b1b4b6; margin-bottom: 24px;">
      <div style="padding: 24px;">
        <h2 style="font-size: 24px; font-weight: bold; color: #0b0c0c; margin: 0 0 20px 0;">Find councils</h2>
        <form method="GET" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Search -->
            <div>
              <label for="q" style="display: block; font-size: 16px; font-weight: bold; color: #0b0c0c; margin-bottom: 8px;">Search</label>
              <input type="text" 
                     name="q" 
                     id="q"
                     value="{{ search_query }}"
                     placeholder="Search by name, slug, or postcode..." 
                     style="width: 100%; padding: 12px; border: 2px solid #0b0c0c; font-size: 16px;"
                     onfocus="this.style.border='2px solid #fd0'; this.style.outline='3px solid #fd0'" 
                     onblur="this.style.border='2px solid #0b0c0c'; this.style.outline='none'">
            </div>

            <!-- Type Filter -->
            <div>
              <label for="type" style="display: block; font-size: 16px; font-weight: bold; color: #0b0c0c; margin-bottom: 8px;">Council Type</label>
              <select name="type" id="type" 
                      style="width: 100%; padding: 12px; border: 2px solid #0b0c0c; font-size: 16px;"
                      onfocus="this.style.border='2px solid #fd0'; this.style.outline='3px solid #fd0'" 
                      onblur="this.style.border='2px solid #0b0c0c'; this.style.outline='none'">
                <option value="">All Types</option>
                {% for council_type in council_types %}
                <option value="{{ council_type.slug }}" {% if council_type_filter == council_type.slug %}selected{% endif %}>
                  {{ council_type.name }}
                </option>
                {% endfor %}
              </select>
            </div>

            <!-- Nation Filter -->
            <div>
              <label for="nation" style="display: block; font-size: 16px; font-weight: bold; color: #0b0c0c; margin-bottom: 8px;">Nation</label>
              <select name="nation" id="nation" 
                      style="width: 100%; padding: 12px; border: 2px solid #0b0c0c; font-size: 16px;"
                      onfocus="this.style.border='2px solid #fd0'; this.style.outline='3px solid #fd0'" 
                      onblur="this.style.border='2px solid #0b0c0c'; this.style.outline='none'">
                <option value="">All Nations</option>
                {% for nation in nations %}
                <option value="{{ nation.slug }}" {% if nation_filter == nation.slug %}selected{% endif %}>
                  {{ nation.name }}
                </option>
                {% endfor %}
              </select>
            </div>

            <!-- Status Filter -->
            <div>
              <label for="status" style="display: block; font-size: 16px; font-weight: bold; color: #0b0c0c; margin-bottom: 8px;">Status</label>
              <select name="status" id="status" 
                      style="width: 100%; padding: 12px; border: 2px solid #0b0c0c; font-size: 16px;"
                      onfocus="this.style.border='2px solid #fd0'; this.style.outline='3px solid #fd0'" 
                      onblur="this.style.border='2px solid #0b0c0c'; this.style.outline='none'">
                <option value="active" {% if status_filter == "active" %}selected{% endif %}>Active</option>
                <option value="inactive" {% if status_filter == "inactive" %}selected{% endif %}>Inactive</option>
                <option value="" {% if not status_filter %}selected{% endif %}>All Status</option>
              </select>
            </div>
          </div>

          <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center space-y-3 sm:space-y-0" style="margin-top: 24px;">
            <div class="flex space-x-3">
              <button type="submit" 
                      style="padding: 12px 20px; background: #00703c; color: white; font-size: 16px; font-weight: bold; border: 2px solid #00703c; cursor: pointer;"
                      onmouseover="this.style.background='#005a30'" onmouseout="this.style.background='#00703c'">
                🔍 Search
              </button>
              <a href="{% url 'council_management_dashboard' %}" 
                 style="display: inline-flex; align-items: center; padding: 12px 20px; background: #f3f2f1; color: #0b0c0c; font-size: 16px; font-weight: bold; text-decoration: none; border: 2px solid #b1b4b6;"
                 onmouseover="this.style.background='#e6e5e4'" onmouseout="this.style.background='#f3f2f1'">
                ❌ Clear
              </a>
            </div>
            {% if search_query or council_type_filter or nation_filter or status_filter != 'active' %}
            <div style="font-size: 16px; color: #626a6e;">
              Showing {{ page_obj|length }} of {{ page_obj.paginator.count }} councils
            </div>
            {% endif %}
          </div>
        </form>
      </div>
    </div>

    <!-- GOV.UK-style Council List -->
    <div id="council-list-section" style="background: white; border: 2px solid #b1b4b6; overflow: hidden;">
      {% if page_obj %}
      <div class="overflow-x-auto">
        <table style="width: 100%; border-collapse: collapse;">
          <thead style="background: #f3f2f1; border-bottom: 2px solid #b1b4b6;">
            <tr>
              <th scope="col" style="padding: 16px 20px; text-align: left; font-size: 16px; font-weight: bold; color: #0b0c0c;">
                Council
              </th>
              <th scope="col" style="padding: 16px 20px; text-align: left; font-size: 16px; font-weight: bold; color: #0b0c0c;">
                Type
              </th>
              <th scope="col" style="padding: 16px 20px; text-align: left; font-size: 16px; font-weight: bold; color: #0b0c0c;">
                Nation
              </th>
              <th scope="col" style="padding: 16px 20px; text-align: left; font-size: 16px; font-weight: bold; color: #0b0c0c;">
                Status
              </th>
              <th scope="col" style="padding: 16px 20px; text-align: left; font-size: 16px; font-weight: bold; color: #0b0c0c;">
                Population
              </th>
              <th scope="col" style="padding: 16px 20px; text-align: right; font-size: 16px; font-weight: bold; color: #0b0c0c;">
                Actions
              </th>
            </tr>
          </thead>
          <tbody style="background: white;">
            {% for council in page_obj %}
            <tr style="border-bottom: 1px solid #b1b4b6;" 
                onmouseover="this.style.background='#f8f8f8'" 
                onmouseout="this.style.background='white'">
              <td style="padding: 16px 20px; white-space: nowrap;">
                <div>
                  <div style="font-size: 16px; font-weight: bold; color: #0b0c0c; margin-bottom: 4px;">
                    <a href="{% url 'council_detail' council.slug %}" 
                       style="color: #1d70b8; text-decoration: underline;"
                       onmouseover="this.style.color='#144e81'" 
                       onmouseout="this.style.color='#1d70b8'">
                      {{ council.name }}
                    </a>
                  </div>
                  <div style="font-size: 14px; color: #626a6e;">{{ council.slug }}</div>
                </div>
              </td>
              <td style="padding: 16px 20px; white-space: nowrap; font-size: 16px; color: #0b0c0c;">
                {% if council.council_type %}
                  <span style="display: inline-block; padding: 4px 8px; background: #1d70b8; color: white; font-size: 12px; font-weight: bold; text-transform: uppercase;">
                    {{ council.council_type.name }}
                  </span>
                {% else %}
                  <span style="color: #626a6e;">-</span>
                {% endif %}
              </td>
              <td style="padding: 16px 20px; white-space: nowrap; font-size: 16px; color: #0b0c0c;">
                {% if council.council_nation %}
                  <span style="display: inline-block; padding: 4px 8px; background: #00703c; color: white; font-size: 12px; font-weight: bold; text-transform: uppercase;">
                    {{ council.council_nation.name }}
                  </span>
                {% else %}
                  <span style="color: #626a6e;">-</span>
                {% endif %}
              </td>
              <td style="padding: 16px 20px; white-space: nowrap;">
                {% if council.status == 'active' %}
                  <span style="display: inline-flex; align-items: center; padding: 4px 8px; background: #00703c; color: white; font-size: 12px; font-weight: bold; text-transform: uppercase;">
                    <span style="width: 8px; height: 8px; background: white; border-radius: 50%; margin-right: 6px;"></span>
                    Active
                  </span>
                {% else %}
                  <span style="display: inline-flex; align-items: center; padding: 4px 8px; background: #626a6e; color: white; font-size: 12px; font-weight: bold; text-transform: uppercase;">
                    <span style="width: 8px; height: 8px; background: white; border-radius: 50%; margin-right: 6px;"></span>
                    Inactive
                  </span>
                {% endif %}
              </td>
              <td style="padding: 16px 20px; white-space: nowrap; font-size: 16px; color: #0b0c0c;">
                {% if council.population %}
                  {{ council.population|floatformat:0 }}
                {% else %}
                  <span style="color: #626a6e;">-</span>
                {% endif %}
              </td>
              <td style="padding: 16px 20px; white-space: nowrap; text-align: right; font-size: 16px;">
                <div class="flex items-center justify-end space-x-3">
                  <a href="{% url 'edit_council' council.id %}" 
                     style="color: #1d70b8; text-decoration: none; font-weight: bold;"
                     onmouseover="this.style.color='#144e81'; this.style.textDecoration='underline'" 
                     onmouseout="this.style.color='#1d70b8'; this.style.textDecoration='none'"
                     title="Edit Council"
                     onclick="logCouncilAction('edit', {{ council.id }}, '{{ council.name|escapejs }}')">
                    ✏️ Edit
                  </a>
                  <button onclick="confirmDelete({{ council.id }}, '{{ council.name|escapejs }}')" 
                          style="color: #d4351c; background: none; border: none; font-weight: bold; cursor: pointer; font-size: 16px;"
                          onmouseover="this.style.color='#942514'; this.style.textDecoration='underline'" 
                          onmouseout="this.style.color='#d4351c'; this.style.textDecoration='none'"
                          title="Delete Council">
                    🗑️ Delete
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- GOV.UK-style Pagination -->
      {% if page_obj.has_other_pages %}
      <div style="background: white; padding: 20px; display: flex; align-items: center; justify-content: space-between; border-top: 2px solid #b1b4b6;">
        <div style="flex: 1;">
          <p style="font-size: 16px; color: #0b0c0c; margin: 0;">
            Showing
            <span style="font-weight: bold;">{{ page_obj.start_index }}</span>
            to
            <span style="font-weight: bold;">{{ page_obj.end_index }}</span>
            of
            <span style="font-weight: bold;">{{ page_obj.paginator.count }}</span>
            councils
          </p>
        </div>
        <div>
          <nav style="display: inline-flex; gap: 8px;" aria-label="Pagination">
            {% if page_obj.has_previous %}
              <a href="?page=1&{{ request.GET.urlencode }}" 
                 style="display: inline-flex; align-items: center; padding: 8px 12px; border: 2px solid #0b0c0c; background: white; font-size: 16px; font-weight: bold; color: #0b0c0c; text-decoration: none;"
                 onmouseover="this.style.background='#f3f2f1'" onmouseout="this.style.background='white'">
                ⏪ First
              </a>
              <a href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode }}" 
                 style="display: inline-flex; align-items: center; padding: 8px 12px; border: 2px solid #0b0c0c; background: white; font-size: 16px; font-weight: bold; color: #0b0c0c; text-decoration: none;"
                 onmouseover="this.style.background='#f3f2f1'" onmouseout="this.style.background='white'">
                ◀ Previous
              </a>
            {% endif %}

            {% for i in page_obj.paginator.page_range %}
              {% if page_obj.number == i %}
                <span style="display: inline-flex; align-items: center; padding: 8px 12px; border: 2px solid #1d70b8; background: #1d70b8; font-size: 16px; font-weight: bold; color: white;">
                  {{ i }}
                </span>
              {% elif i > page_obj.number|add:'-3' and i < page_obj.number|add:'3' %}
                <a href="?page={{ i }}&{{ request.GET.urlencode }}" 
                   style="display: inline-flex; align-items: center; padding: 8px 12px; border: 2px solid #0b0c0c; background: white; font-size: 16px; font-weight: bold; color: #0b0c0c; text-decoration: none;"
                   onmouseover="this.style.background='#f3f2f1'" onmouseout="this.style.background='white'">
                  {{ i }}
                </a>
              {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
              <a href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode }}" 
                 style="display: inline-flex; align-items: center; padding: 8px 12px; border: 2px solid #0b0c0c; background: white; font-size: 16px; font-weight: bold; color: #0b0c0c; text-decoration: none;"
                 onmouseover="this.style.background='#f3f2f1'" onmouseout="this.style.background='white'">
                Next ▶
              </a>
              <a href="?page={{ page_obj.paginator.num_pages }}&{{ request.GET.urlencode }}" 
                 style="display: inline-flex; align-items: center; padding: 8px 12px; border: 2px solid #0b0c0c; background: white; font-size: 16px; font-weight: bold; color: #0b0c0c; text-decoration: none;"
                 onmouseover="this.style.background='#f3f2f1'" onmouseout="this.style.background='white'">
                Last ⏩
              </a>
            {% endif %}
          </nav>
        </div>
      </div>
      {% endif %}
      {% else %}
      <div style="text-align: center; padding: 48px 24px;">
        <div style="font-size: 48px; margin-bottom: 16px;">🏛️</div>
        <h3 style="font-size: 24px; font-weight: bold; color: #0b0c0c; margin: 0 0 8px 0;">No councils found</h3>
        <p style="font-size: 16px; color: #626a6e; margin: 0 0 24px 0;">
          {% if search_query or council_type_filter or nation_filter or status_filter != 'active' %}
            No councils match your current filters.
          {% else %}
            Get started by creating your first council.
          {% endif %}
        </p>
        <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
          {% if search_query or council_type_filter or nation_filter or status_filter != 'active' %}
            <a href="{% url 'council_management_dashboard' %}" 
               style="display: inline-flex; align-items: center; padding: 12px 20px; background: #f3f2f1; color: #0b0c0c; font-size: 16px; font-weight: bold; text-decoration: none; border: 2px solid #b1b4b6;"
               onmouseover="this.style.background='#e6e5e4'" onmouseout="this.style.background='#f3f2f1'">
              ❌ Clear Filters
            </a>
          {% endif %}
          <a href="{% url 'create_council' %}" 
             style="display: inline-flex; align-items: center; padding: 12px 20px; background: #1d70b8; color: white; font-size: 16px; font-weight: bold; text-decoration: none; border: 2px solid #1d70b8;"
             onmouseover="this.style.background='#144e81'" onmouseout="this.style.background='#1d70b8'"
             onclick="logCouncilAction('create_attempt', null, null)">
            ➕ Create Council
          </a>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- GOV.UK-style Modal for Delete Confirmation -->
<div id="deleteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(11, 12, 12, 0.8); z-index: 1000;">
  <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border: 4px solid #d4351c; padding: 32px; max-width: 600px; width: 90%;">
    <h2 style="font-size: 24px; font-weight: bold; color: #d4351c; margin: 0 0 16px 0;">
      ⚠️ Delete Council
    </h2>
    <div id="deleteModalContent" style="color: #0b0c0c; font-size: 16px; line-height: 1.5; margin: 0 0 24px 0;"></div>
    <div style="display: flex; gap: 12px; justify-content: flex-end;">
      <button onclick="cancelDelete()" 
              style="padding: 12px 20px; background: #f3f2f1; color: #0b0c0c; font-size: 16px; font-weight: bold; border: 2px solid #b1b4b6; cursor: pointer;"
              onmouseover="this.style.background='#e6e5e4'" onmouseout="this.style.background='#f3f2f1'">
        Cancel
      </button>
      <button id="confirmDeleteBtn" onclick="executeDelete()" 
              style="padding: 12px 20px; background: #d4351c; color: white; font-size: 16px; font-weight: bold; border: 2px solid #d4351c; cursor: pointer;"
              onmouseover="this.style.background='#942514'" onmouseout="this.style.background='#d4351c'">
        Delete Council
      </button>
    </div>
  </div>
</div>

<!-- Hidden Delete Form -->
<form id="deleteForm" method="POST" style="display: none;">
  {% csrf_token %}
</form>

<script>
// Enhanced error reporting and analytics for Council Management
const CouncilManagementAnalytics = {
  // Log council management actions to Event Viewer
  logEvent: function(source, level, category, title, message, details = {}) {
    fetch('/api/event-viewer/log/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({
        source: source,
        level: level,
        category: category,
        title: title,
        message: message,
        details: details,
        request_path: window.location.pathname,
        timestamp: new Date().toISOString()
      })
    }).catch(error => {
      console.error('Failed to log event:', error);
    });
  },

  // Performance monitoring
  trackPerformance: function(action, startTime) {
    const duration = performance.now() - startTime;
    this.logEvent(
      'council_management',
      duration > 2000 ? 'warning' : 'info',
      'performance',
      `Council Management ${action} Performance`,
      `${action} took ${duration.toFixed(2)}ms`,
      { duration_ms: Math.round(duration), action: action }
    );
  },

  // Error tracking
  trackError: function(error, context) {
    this.logEvent(
      'council_management',
      'error',
      'exception',
      'Council Management Error',
      error.message || error.toString(),
      {
        error_type: error.name || 'Error',
        context: context,
        stack_trace: error.stack,
        user_agent: navigator.userAgent
      }
    );
  },

  // User action tracking
  trackUserAction: function(action, councilId, councilName, details = {}) {
    this.logEvent(
      'council_management',
      'info',
      'user_activity',
      `Council Management: ${action}`,
      `User performed ${action} on council ${councilName || councilId}`,
      {
        action: action,
        council_id: councilId,
        council_name: councilName,
        ...details
      }
    );
  }
};

// Global function for logging council actions
function logCouncilAction(action, councilId, councilName, details = {}) {
  try {
    CouncilManagementAnalytics.trackUserAction(action, councilId, councilName, details);
  } catch (error) {
    console.error('Failed to log council action:', error);
  }
}

// Delete confirmation with enhanced UX and logging
let pendingDeleteCouncilId = null;
let pendingDeleteCouncilName = null;

function confirmDelete(councilId, councilName) {
  try {
    const startTime = performance.now();
    
    pendingDeleteCouncilId = councilId;
    pendingDeleteCouncilName = councilName;
    
    // Enhanced delete confirmation content
    const modalContent = document.getElementById('deleteModalContent');
    modalContent.innerHTML = `
      <p><strong>You are about to delete:</strong> ${councilName}</p>
      <div style="background: #fff2f2; border: 2px solid #d4351c; padding: 16px; margin: 16px 0;">
        <p style="margin: 0 0 8px 0; font-weight: bold; color: #d4351c;">This action cannot be undone and will permanently remove:</p>
        <ul style="margin: 0; padding-left: 20px; color: #0b0c0c;">
          <li>All financial figures and historical data</li>
          <li>Council characteristics and metadata</li>
          <li>Activity logs and contribution history</li>
          <li>Any associated factoids and analytics</li>
        </ul>
      </div>
      <p style="font-weight: bold;">Are you sure you want to continue?</p>
    `;
    
    // Show modal
    document.getElementById('deleteModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
    
    // Log delete confirmation attempt
    logCouncilAction('delete_confirmation_shown', councilId, councilName);
    
    // Track performance
    CouncilManagementAnalytics.trackPerformance('delete_confirmation_display', startTime);
    
  } catch (error) {
    CouncilManagementAnalytics.trackError(error, 'confirmDelete');
    // Fallback to basic confirm dialog
    if (confirm(`Delete council '${councilName}'? This cannot be undone.`)) {
      const form = document.getElementById('deleteForm');
      form.action = `/god-mode/councils/${councilId}/delete/`;
      form.submit();
    }
  }
}

function cancelDelete() {
  try {
    // Log cancellation
    logCouncilAction('delete_cancelled', pendingDeleteCouncilId, pendingDeleteCouncilName);
    
    // Hide modal
    document.getElementById('deleteModal').style.display = 'none';
    document.body.style.overflow = 'auto';
    
    // Clear pending state
    pendingDeleteCouncilId = null;
    pendingDeleteCouncilName = null;
    
  } catch (error) {
    CouncilManagementAnalytics.trackError(error, 'cancelDelete');
  }
}

function executeDelete() {
  try {
    const startTime = performance.now();
    
    if (!pendingDeleteCouncilId) {
      throw new Error('No council selected for deletion');
    }
    
    // Log deletion execution
    logCouncilAction('delete_confirmed', pendingDeleteCouncilId, pendingDeleteCouncilName, {
      confirmation_method: 'modal',
      timestamp: new Date().toISOString()
    });
    
    // Submit form
    const form = document.getElementById('deleteForm');
    form.action = `/god-mode/councils/${pendingDeleteCouncilId}/delete/`;
    form.submit();
    
    // Track performance
    CouncilManagementAnalytics.trackPerformance('delete_execution', startTime);
    
  } catch (error) {
    CouncilManagementAnalytics.trackError(error, 'executeDelete');
    alert('An error occurred while deleting the council. Please try again.');
  }
}

// Enhanced page functionality with analytics
document.addEventListener('DOMContentLoaded', function() {
  const startTime = performance.now();
  
  try {
    // Log page load
    CouncilManagementAnalytics.trackUserAction('page_loaded', null, null, {
      council_count: {{ page_obj.paginator.count|default:0 }},
      has_filters: {% if search_query or council_type_filter or nation_filter or status_filter != 'active' %}true{% else %}false{% endif %},
      current_page: {{ page_obj.number|default:1 }}
    });
    
    // Auto-submit search form on filter changes with analytics
    const filterSelects = document.querySelectorAll('#type, #nation, #status');
    filterSelects.forEach(select => {
      select.addEventListener('change', function() {
        logCouncilAction('filter_changed', null, null, {
          filter_type: this.id,
          filter_value: this.value,
          previous_value: this.dataset.previousValue || ''
        });
        this.dataset.previousValue = this.value;
        this.form.submit();
      });
    });
    
    // Track search usage
    const searchInput = document.getElementById('q');
    if (searchInput) {
      let searchTimeout;
      searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          if (this.value.length > 2) {
            logCouncilAction('search_query_entered', null, null, {
              query_length: this.value.length,
              query: this.value.substring(0, 50) // Limit logged query length
            });
          }
        }, 1000);
      });
    }
    
    // Monitor for JavaScript errors
    window.addEventListener('error', function(event) {
      CouncilManagementAnalytics.trackError(event.error || new Error(event.message), 'global_error_handler');
    });
    
    // Monitor for unhandled promise rejections
    window.addEventListener('unhandledrejection', function(event) {
      CouncilManagementAnalytics.trackError(new Error(event.reason), 'unhandled_promise_rejection');
    });
    
    // Close modal on escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape' && document.getElementById('deleteModal').style.display === 'block') {
        cancelDelete();
      }
    });
    
    // Close modal on background click
    document.getElementById('deleteModal').addEventListener('click', function(event) {
      if (event.target === this) {
        cancelDelete();
      }
    });
    
    // Track page load performance
    CouncilManagementAnalytics.trackPerformance('page_load', startTime);
    
  } catch (error) {
    CouncilManagementAnalytics.trackError(error, 'DOMContentLoaded');
  }
});

// Track page unload for session analytics
window.addEventListener('beforeunload', function() {
  try {
    logCouncilAction('page_unloaded', null, null, {
      session_duration: performance.now(),
      timestamp: new Date().toISOString()
    });
  } catch (error) {
    // Silently fail on page unload
    console.error('Failed to log page unload:', error);
  }
});
</script>

{% endblock %}

<!-- Enhanced GOV.UK-style Status Bar -->
<div id="status-bar" style="position: fixed; bottom: 0; left: 0; right: 0; background: #0b0c0c; color: white; padding: 8px 16px; font-size: 14px; display: none; z-index: 999;">
  <div style="max-width: 1200px; margin: 0 auto; display: flex; justify-content: between; align-items: center;">
    <span id="status-message"></span>
    <button onclick="hideStatusBar()" style="background: none; border: none; color: white; font-size: 16px; cursor: pointer; margin-left: auto;">×</button>
  </div>
</div>

<script>
// Status bar functionality
function showStatusBar(message, type = 'info', duration = 5000) {
  const statusBar = document.getElementById('status-bar');
  const statusMessage = document.getElementById('status-message');
  
  // Set message
  statusMessage.textContent = message;
  
  // Set color based on type
  switch(type) {
    case 'success':
      statusBar.style.background = '#00703c';
      break;
    case 'warning':
      statusBar.style.background = '#f47738';
      break;
    case 'error':
      statusBar.style.background = '#d4351c';
      break;
    default:
      statusBar.style.background = '#1d70b8';
  }
  
  // Show status bar
  statusBar.style.display = 'block';
  
  // Auto-hide after duration
  if (duration > 0) {
    setTimeout(hideStatusBar, duration);
  }
}

function hideStatusBar() {
  document.getElementById('status-bar').style.display = 'none';
}

// Show status messages from Django messages framework
{% if messages %}
  document.addEventListener('DOMContentLoaded', function() {
    {% for message in messages %}
      showStatusBar('{{ message|escapejs }}', '{{ message.tags }}', 8000);
    {% endfor %}
  });
{% endif %}
</script>