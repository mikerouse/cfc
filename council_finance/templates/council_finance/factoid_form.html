{% extends "base.html" %}
{% block title %}Edit Factoid - Council Finance Counters{% endblock %}
{% block content %}
<h1 class="text-2xl font-bold mb-4">{{ form.instance.pk|yesno:'Edit Factoid,Add Factoid' }}</h1>
<form method="post" class="space-y-4">
    {% csrf_token %}
    <table class="min-w-full border border-gray-300">
        <tbody>
            {% for field in form %}
            <tr class="odd:bg-gray-50">
                <th class="text-left p-2 border w-40">{{ field.label_tag }}</th>
                <td class="p-2 border">
                    {{ field }}
                    {% if field.help_text %}
                        <p class="text-sm text-gray-600">{{ field.help_text }}</p>
                    {% endif %}
                    {{ field.errors }}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div class="mt-2 p-2 bg-gray-50 rounded" id="preview-card">
        <div class="flex items-center gap-2 mb-2">
            <p class="text-sm text-gray-600 mb-0">Preview for</p>
            <select id="preview-council" class="border rounded px-2 py-1">
                {% for c in councils %}
                    <option value="{{ c.slug }}">{{ c.name }}</option>
                {% endfor %}
            </select>
            <span class="text-sm text-gray-600">Year</span>
            <select id="preview-year" class="border rounded px-2 py-1">
                {% for y in years %}
                    <option value="{{ y.label }}">{{ y.label }}</option>
                {% endfor %}
            </select>
        </div>
        <p class="text-sm text-gray-600" id="preview-text"></p>
    </div>
    <div class="text-right">
        <button type="submit" class="bg-blue-600 text-white px-4 py-1 rounded">Save</button>
    </div>
</form>
{{ form.DEFAULT_TEXTS|json_script:"factoid-defaults" }}
<script>
const defaults = JSON.parse(document.getElementById('factoid-defaults').textContent);
const typeField = document.getElementById('id_factoid_type');
const textField = document.getElementById('id_text');
function applyDefault(){
    if(!textField.value){
        textField.value = defaults[typeField.value] || '';
    }
}
if(typeField){
    typeField.addEventListener('change', applyDefault);
    // Apply once on load in case the type has a predefined default
    applyDefault();
}

async function updatePreview(){
    const counterSel = document.getElementById('id_counters');
    const siteSel = document.getElementById('id_site_counters');
    const groupSel = document.getElementById('id_group_counters');
    const counter = counterSel && counterSel.value || siteSel && siteSel.value || groupSel && groupSel.value;
    if(!counter){
        document.getElementById('preview-text').textContent = 'Select a counter to preview';
        return;
    }
    const url = new URL('{% url 'preview_factoid' %}', window.location.origin);
    url.searchParams.append('counter', counter);
    url.searchParams.append('council', document.getElementById('preview-council').value);
    url.searchParams.append('year', document.getElementById('preview-year').value);
    url.searchParams.append('type', typeField.value);
    url.searchParams.append('text', textField.value);
    try{
        const resp = await fetch(url, {headers:{'X-Requested-With':'XMLHttpRequest'}});
        const data = await resp.json();
        document.getElementById('preview-text').textContent = data.text || data.error || 'Error';
    }catch(e){
        document.getElementById('preview-text').textContent = 'Error';
    }
}

['id_text','id_factoid_type','id_counters','id_site_counters','id_group_counters'].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.addEventListener('change', updatePreview);
});
document.getElementById('preview-council').addEventListener('change', updatePreview);
document.getElementById('preview-year').addEventListener('change', updatePreview);
setTimeout(updatePreview,100);
</script>
{% endblock %}
