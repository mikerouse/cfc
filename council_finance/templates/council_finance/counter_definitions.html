{% extends "base.html" %}
{% block title %}Counter Definitions - Council Finance Counters{% endblock %}
{% block content %}
<h1 class="text-2xl font-bold mb-4">Counter Definitions</h1>
<p class="mb-2">Click or drag fields into the formula boxes to build your counters.</p>
<div class="flex flex-wrap gap-2 mb-4">
    {% for field in available_fields %}
    <span class="px-2 py-1 bg-gray-200 rounded cursor-pointer draggable-field" draggable="true" data-insert="{{ field }}">{{ field }}</span>
    {% endfor %}
    <span class="px-2 py-1 bg-gray-200 rounded cursor-pointer op" data-insert="+">+</span>
    <span class="px-2 py-1 bg-gray-200 rounded cursor-pointer op" data-insert="-">-</span>
    <span class="px-2 py-1 bg-gray-200 rounded cursor-pointer op" data-insert="*">*</span>
    <span class="px-2 py-1 bg-gray-200 rounded cursor-pointer op" data-insert="/">/</span>
</div>
<form method="post">
    {% csrf_token %}
    {{ formset.management_form }}
    <div class="space-y-4">
        {% for form in formset %}
        <div class="border p-4 rounded counter-form" data-prefix="{{ form.prefix }}">
            {{ form.id }}
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                {{ form.name.label_tag }} {{ form.name }}
                {{ form.slug.label_tag }} {{ form.slug }}
                {{ form.formula.label_tag }} {{ form.formula }}
                {{ form.explanation.label_tag }} {{ form.explanation }}
                {{ form.duration.label_tag }} {{ form.duration }}
                {{ form.precision.label_tag }} {{ form.precision }}
                {{ form.show_currency.label_tag }} {{ form.show_currency }}
                {{ form.friendly_format.label_tag }} {{ form.friendly_format }}
            </div>
            <div class="mt-2 p-2 bg-gray-50 rounded preview-card">
                <p class="text-sm text-gray-600">Preview</p>
                <p class="text-lg font-bold preview-value">0</p>
            </div>
        </div>
        {% endfor %}
    </div>
    <button class="mt-4 bg-blue-600 text-white px-4 py-1 rounded" type="submit">Save</button>
</form>
{# Pass the list of allowed fields into JavaScript so we can validate formulas #}
{{ available_fields|json_script:"available-fields" }}
<script>
// Store the array of valid field names for reference when checking expressions
const AVAILABLE_FIELDS = JSON.parse(document.getElementById('available-fields').textContent);

let activeInput = null;
// Enhance each formula input so users can drag fields in and validate content
document.querySelectorAll('input[name$="-formula"]').forEach(inp => {
    // Insert a span after the input to show validation errors
    const error = document.createElement('span');
    error.className = 'text-sm text-red-600 hidden';
    inp.after(error);

    inp.classList.add('formula-input');
    inp.addEventListener('focus', () => (activeInput = inp));
    inp.addEventListener('drop', e => {
        e.preventDefault();
        const val = e.dataTransfer.getData('text/plain');
        inp.value += val;
        validate();
    });
    inp.addEventListener('dragover', e => e.preventDefault());
    inp.addEventListener('input', validate);

    // Validate the expression using math.js to catch simple mistakes
    function validate() {
        try {
            const expr = math.parse(inp.value || '0');
            // Walk the syntax tree and ensure only known fields are referenced
            expr.traverse(node => {
                if (node.isSymbolNode && !AVAILABLE_FIELDS.includes(node.name)) {
                    throw new Error('Unknown field: ' + node.name);
                }
            });
            error.classList.add('hidden');
        } catch (err) {
            error.textContent = 'Invalid formula';
            error.classList.remove('hidden');
        }
    }
});

// Allow clicking or dragging fields/operators into whichever input is active
document.querySelectorAll('[data-insert]').forEach(el => {
    el.addEventListener('click', () => {
        if (activeInput) {
            activeInput.value += el.dataset.insert;
            activeInput.focus();
            activeInput.dispatchEvent(new Event('input'));
        }
    });
    el.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/plain', el.dataset.insert);
    });
});

// Build an object with sample numbers used for the preview calculation.
const SAMPLE_VALUES = {};
AVAILABLE_FIELDS.forEach(f => {
    SAMPLE_VALUES[f] = 1000000; // one million as an easy to read default
});

// Update the preview card for each form whenever relevant fields change.
function attachPreview(container) {
    const prefix = container.dataset.prefix;
    const formula = container.querySelector(`input[name="${prefix}-formula"]`);
    const precision = container.querySelector(`input[name="${prefix}-precision"]`);
    const showCurrency = container.querySelector(`input[name="${prefix}-show_currency"]`);
    const friendly = container.querySelector(`input[name="${prefix}-friendly_format"]`);
    const preview = container.querySelector('.preview-value');

    const inputs = [formula, precision, showCurrency, friendly];
    inputs.forEach(i => i && i.addEventListener('input', update));
    inputs.forEach(i => i && i.addEventListener('change', update));

    // Format a value according to the settings mirroring CounterDefinition.format_value
    function formatValue(v) {
        const prec = parseInt(precision.value || '0');
        const sc = showCurrency.checked;
        const ff = friendly.checked;
        let out;
        if (ff) {
            const abs = Math.abs(v);
            if (abs >= 1_000_000_000) {
                out = (v / 1_000_000_000).toFixed(1) + 'b';
            } else if (abs >= 1_000_000) {
                out = (v / 1_000_000).toFixed(1) + 'm';
            } else if (abs >= 1_000) {
                out = (v / 1_000).toFixed(1) + 'k';
            } else {
                out = v.toFixed(prec);
            }
        } else {
            out = v.toLocaleString(undefined, {minimumFractionDigits: prec, maximumFractionDigits: prec});
        }
        return sc ? 'Â£' + out : out;
    }

    function update() {
        try {
            const val = math.evaluate(formula.value || '0', SAMPLE_VALUES);
            preview.textContent = formatValue(val);
        } catch (err) {
            preview.textContent = 'Invalid';
        }
    }

    update();
}

document.querySelectorAll('.counter-form').forEach(attachPreview);
</script>
{% endblock %}

