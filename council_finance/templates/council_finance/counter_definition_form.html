{% extends "base.html" %}
{% block title %}Edit Counter - Council Finance Counters{% endblock %}
{% block content %}
<h1 class="text-2xl font-bold mb-4">{{ form.instance.pk|yesno:'Edit Counter,Add Counter' }}</h1>
<p class="mb-2">Click or drag fields into the formula box to build your counter.</p>
<div class="flex flex-wrap gap-2 mb-4">
    {% for field in available_fields %}
    <span class="px-2 py-1 bg-gray-200 rounded cursor-pointer" draggable="true" data-insert="{{ field }}">{{ field }}</span>
    {% endfor %}
    <span class="px-2 py-1 bg-gray-200 rounded cursor-pointer" data-insert="+">+</span>
    <span class="px-2 py-1 bg-gray-200 rounded cursor-pointer" data-insert="-">-</span>
    <span class="px-2 py-1 bg-gray-200 rounded cursor-pointer" data-insert="*">*</span>
    <span class="px-2 py-1 bg-gray-200 rounded cursor-pointer" data-insert="/">/</span>
</div>
<form method="post" class="space-y-4">
    {% csrf_token %}
    {{ form.non_field_errors }}
    <table class="min-w-full border border-gray-300">
        <tbody>
            <tr class="odd:bg-gray-50">
                <th class="text-left p-2 border w-40">{{ form.name.label_tag }}</th>
                <td class="p-2 border">
                    {{ form.name }}
                    {{ form.name.errors }}
                </td>
            </tr>
            <tr class="odd:bg-gray-50">
                <th class="text-left p-2 border">{{ form.slug.label_tag }}</th>
                <td class="p-2 border">
                    {{ form.slug }}
                    {{ form.slug.errors }}
                </td>
            </tr>
            <tr class="odd:bg-gray-50">
                <th class="text-left p-2 border">{{ form.formula.label_tag }}</th>
                <td class="p-2 border">
                    {{ form.formula }}
                    {{ form.formula.errors }}
                </td>
            </tr>
            <tr class="odd:bg-gray-50">
                <th class="text-left p-2 border">{{ form.explanation.label_tag }}</th>
                <td class="p-2 border">
                    {{ form.explanation }}
                    {{ form.explanation.errors }}
                </td>
            </tr>
            <tr class="odd:bg-gray-50">
                <th class="text-left p-2 border">{{ form.duration.label_tag }}</th>
                <td class="p-2 border">
                    {{ form.duration }}
                    {{ form.duration.errors }}
                </td>
            </tr>
            <tr class="odd:bg-gray-50">
                <th class="text-left p-2 border">{{ form.precision.label_tag }}</th>
                <td class="p-2 border">
                    {{ form.precision }}
                    {{ form.precision.errors }}
                </td>
            </tr>
            <tr class="odd:bg-gray-50">
                <th class="text-left p-2 border">{{ form.show_currency.label_tag }}</th>
                <td class="p-2 border flex items-center">
                    {{ form.show_currency }} {{ form.show_currency.help_text }}
                    {{ form.show_currency.errors }}
                </td>
            </tr>
            <tr class="odd:bg-gray-50">
                <th class="text-left p-2 border">{{ form.friendly_format.label_tag }}</th>
                <td class="p-2 border flex items-center">
                    {{ form.friendly_format }} {{ form.friendly_format.help_text }}
                    {{ form.friendly_format.errors }}
                </td>
            </tr>
            <tr class="odd:bg-gray-50">
                <th class="text-left p-2 border">{{ form.show_by_default.label_tag }}</th>
                <td class="p-2 border flex items-center">
                    {{ form.show_by_default }} {{ form.show_by_default.help_text }}
                    {{ form.show_by_default.errors }}
                </td>
            </tr>
            <tr class="odd:bg-gray-50">
                <th class="text-left p-2 border">{{ form.headline.label_tag }}</th>
                <td class="p-2 border flex items-center">
                    {{ form.headline }} {{ form.headline.help_text }}
                    {{ form.headline.errors }}
                </td>
            </tr>
        </tbody>
    </table>
<div class="mt-2 p-2 bg-gray-50 rounded" id="preview-card">
    <div class="flex items-center gap-2 mb-2">
        <p class="text-sm text-gray-600 mb-0">Preview for</p>
        <select id="preview-council" class="border rounded px-2 py-1">
            {% for council in councils %}
                <option value="{{ council.slug }}" {% if council.slug == preview_council_slug %}selected{% endif %}>{{ council.name }}</option>
            {% endfor %}
        </select>
        <span class="text-sm text-gray-600">Year</span>
        <select id="preview-year" class="border rounded px-2 py-1">
            {% for year in years %}
                <option value="{{ year.label }}" {% if year.label == preview_year_label %}selected{% endif %}>{{ year.label }}</option>
            {% endfor %}
        </select>
    </div>
    <p class="text-lg font-bold" id="preview-value">0</p>
</div>
    <div class="mt-4">
        <button class="bg-blue-600 text-white px-4 py-1 rounded" type="submit">Save</button>
        <a href="{% url 'counter_definitions' %}" class="ml-2 underline">Cancel</a>
    </div>
</form>
{{ available_fields|json_script:"available-fields" }}
<script>
const AVAILABLE_FIELDS = JSON.parse(document.getElementById('available-fields').textContent);
let activeInput = null;
const formulaInput = document.getElementById('id_formula');

const previewEl = document.getElementById('preview-value');
const previewCouncil = document.getElementById('preview-council');
const previewYear = document.getElementById('preview-year');
function getPreviewParams() {
    return {
        council: previewCouncil.value,
        year: previewYear.value,
        formula: formulaInput.value,
        precision: document.getElementById('id_precision').value,
        show_currency: document.getElementById('id_show_currency').checked,
        friendly_format: document.getElementById('id_friendly_format').checked,
    };
}
async function updatePreview() {
    const params = getPreviewParams();
    const url = new URL("{% url 'preview_counter_value' %}", window.location.origin);
    Object.entries(params).forEach(([k, v]) => url.searchParams.append(k, v));
    previewEl.textContent = '...';
    try {
        const resp = await fetch(url, {headers: {'X-Requested-With': 'XMLHttpRequest'}});
        const data = await resp.json();
        if (data.formatted !== undefined) {
            previewEl.textContent = data.formatted;
        } else {
            previewEl.textContent = data.error || 'Invalid';
        }
    } catch (e) {
        previewEl.textContent = 'Error';
    }
}
if (formulaInput) {
    formulaInput.addEventListener('focus', () => activeInput = formulaInput);
    formulaInput.addEventListener('input', updatePreview);
}
if (previewCouncil) {
    previewCouncil.addEventListener('change', updatePreview);
}
if (previewYear) {
    previewYear.addEventListener('change', updatePreview);
}
['id_precision', 'id_show_currency', 'id_friendly_format'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('change', updatePreview);
});
setTimeout(updatePreview, 100);

document.querySelectorAll('[data-insert]').forEach(el => {
    el.addEventListener('click', () => {
        if (activeInput) {
            activeInput.value += el.dataset.insert;
            activeInput.dispatchEvent(new Event('input'));
            activeInput.focus();
        }
    });
    el.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/plain', el.dataset.insert);
    });
});

const SAMPLE_VALUES = {};
AVAILABLE_FIELDS.forEach(f => SAMPLE_VALUES[f] = 1000000);
function formatValue(v) {
    const prec = parseInt(document.getElementById('id_precision').value || '0');
    const sc = document.getElementById('id_show_currency').checked;
    const ff = document.getElementById('id_friendly_format').checked;
    let out;
    if (ff) {
        const abs = Math.abs(v);
        if (abs >= 1_000_000_000) { out = (v / 1_000_000_000).toFixed(1) + 'b'; }
        else if (abs >= 1_000_000) { out = (v / 1_000_000).toFixed(1) + 'm'; }
        else if (abs >= 1_000) { out = (v / 1_000).toFixed(1) + 'k'; }
        else { out = v.toFixed(prec); }
    } else {
        out = v.toLocaleString(undefined, {minimumFractionDigits: prec, maximumFractionDigits: prec});
    }
    return sc ? 'Â£' + out : out;
}
function update() {
    try {
        const val = math.evaluate(formulaInput.value || '0', SAMPLE_VALUES);
        previewEl.textContent = formatValue(val);
    } catch (err) {
        previewEl.textContent = 'Invalid';
    }
}
update();
</script>
{% endblock %}

