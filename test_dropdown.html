<!DOCTYPE html>
<html>
<head>
    <title>Test Dropdown Functionality</title>
    <style>
        .hidden { display: none !important; }
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-container { margin: 20px 0; padding: 20px; border: 1px solid #ccc; }
        input, select { padding: 8px; margin: 5px; width: 200px; }
        button { padding: 8px 16px; margin: 5px; }
    </style>
</head>
<body>
    <h1>Dropdown Test</h1>
    
    <div class="test-container">
        <h3>Test Field Options Loading</h3>
        <p>This tests the loadFieldOptions functionality directly.</p>
        
        <div>
            <label>Text Input (should hide when dropdown loads):</label><br>
            <input type="text" id="edit-value" placeholder="Enter value...">
        </div>
        
        <div>
            <label>Dropdown (should show when options are loaded):</label><br>
            <select id="edit-value-select" class="hidden">
                <option>Loading...</option>
            </select>
        </div>
        
        <div>
            <button onclick="testCouncilType()">Test Council Type</button>
            <button onclick="testCouncilNation()">Test Council Nation</button>
            <button onclick="testInvalidField()">Test Invalid Field</button>
        </div>
        
        <div id="debug-output" style="margin-top: 20px; background: #f5f5f5; padding: 10px; font-family: monospace;"></div>
    </div>

    <script>
        // Mock the loadFieldOptions functionality
        const editValue = document.getElementById('edit-value');
        const editValueSelect = document.getElementById('edit-value-select');
        const debugOutput = document.getElementById('debug-output');
        
        function log(message) {
            debugOutput.innerHTML += message + '<br>';
            console.log(message);
        }
        
        async function loadFieldOptions(fieldSlug) {
            log(`[DEBUG] Loading field options for: ${fieldSlug}`);
            try {
                const resp = await fetch(`http://127.0.0.1:8000/contribute/field-options/${fieldSlug}/`, {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                
                log(`[DEBUG] Response status: ${resp.status}`);
                
                if (resp.ok) {
                    const data = await resp.json();
                    log(`[DEBUG] Response data: ${JSON.stringify(data)}`);
                    
                    if (data.options && data.options.length > 0) {
                        log(`[DEBUG] Found ${data.options.length} options, switching to dropdown`);
                        
                        // Show select dropdown instead of text input
                        editValue.classList.add('hidden');
                        editValueSelect.classList.remove('hidden');
                        
                        editValueSelect.innerHTML = '<option value="">Select...</option>';
                        data.options.forEach(option => {
                            const opt = document.createElement('option');
                            opt.value = option.id;
                            opt.textContent = option.name;
                            editValueSelect.appendChild(opt);
                        });
                        
                        editValueSelect.focus();
                        log(`[DEBUG] Dropdown populated and focused`);
                    } else {
                        log(`[DEBUG] No options found, keeping text input`);
                    }
                } else {
                    log(`[DEBUG] Response not OK: ${resp.statusText}`);
                }
            } catch (error) {
                log(`[ERROR] Failed to load field options: ${error}`);
            }
        }
        
        function resetForm() {
            editValue.classList.remove('hidden');
            editValueSelect.classList.add('hidden');
            editValue.value = '';
            editValueSelect.innerHTML = '<option>Loading...</option>';
        }
        
        async function testCouncilType() {
            log('=== Testing Council Type ===');
            resetForm();
            await loadFieldOptions('council_type');
        }
        
        async function testCouncilNation() {
            log('=== Testing Council Nation ===');
            resetForm();
            await loadFieldOptions('council_nation');
        }
        
        async function testInvalidField() {
            log('=== Testing Invalid Field ===');
            resetForm();
            await loadFieldOptions('invalid_field_name');
        }
        
        log('Test page loaded. Click buttons to test functionality.');
    </script>
</body>
</html>
